<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coursio | Accueil</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="hero">
    <div class="glass"></div>
    <div class="hero__content">
      <div class="badge">Nouveau ‚Ä¢ Plateforme de cours intelligente</div>
      <p class="subtitle">Configurez vos cours en quelques clics et organisez vos activit√©s dans un planning clair, pens√© pour vos apprenants.</p>
      <div class="cta">
        <a class="btn btn-primary" href="#explorer">D√©couvrir</a>
        <a class="btn btn-secondary" href="#demo">Voir la d√©mo</a>
      </div>
      <div class="hero__stats">
        <div>
          <span class="stat">350+</span>
          <p>le√ßons publi√©es</p>
        </div>
        <div>
          <span class="stat">92%</span>
          <p>taux de satisfaction</p>
        </div>
        <div>
          <span class="stat">24/7</span>
          <p>assistance apprenants</p>
        </div>
      </div>
    </div>
  </header>

  <main class="sections">
    <section class="section" id="explorer">
      <div class="section__title">Cr√©ez, publiez, inspirez.</div>
      <p class="section__subtitle">Tout ce qu'il faut pour mettre en ligne vos parcours d'apprentissage et s√©duire vos futurs √©l√®ves.</p>
      <div class="cards">
        <article class="card">
          <div class="icon">üéØ</div>
          <h3>Objectifs clairs</h3>
          <p>Des parcours structur√©s avec des jalons visuels, pour que chaque visiteur comprenne votre promesse.</p>
        </article>
        <article class="card">
          <div class="icon">üß†</div>
          <h3>Apprentissage guid√©</h3>
          <p>Des modules courts, des contenus multim√©dia et des interactions pr√©vues pour engager vos apprenants.</p>
        </article>
        <article class="card">
          <div class="icon">ü§ù</div>
          <h3>Communaut√©</h3>
          <p>Un espace chaleureux o√π vos √©l√®ves peuvent √©changer, poser des questions et partager leurs r√©ussites.</p>
        </article>
      </div>
    </section>

    <section class="section planner" id="demo">
      <div class="planner__intro">
        <div class="section__title">Planifiez vos activit√©s</div>
        <p class="section__subtitle">Par d√©faut, chaque cours est structur√© en 5 semaines de 2 demi-jours. Utilisez le formulaire pour ajouter vos activit√©s et visualiser imm√©diatement leur placement.</p>
        <div class="pill-list">
          <span class="pill">5 semaines</span>
          <span class="pill">2 demi-jours / semaine</span>
          <span class="pill">Activit√©s illimit√©es</span>
        </div>
        <div class="connection-status" id="db-status" aria-live="polite">
          <span class="status-dot status-dot--checking" id="db-status-dot" aria-hidden="true"></span>
          <span id="db-status-text">V√©rification de la connexion √† la base...</span>
        </div>
      </div>

      <div class="planner__grid">
        <form class="activity-form" id="activity-form">
          <h3>Nouvelle activit√©</h3>
          <label class="form-field">
            <span>Nom de l'activit√©</span>
            <input type="text" id="activity-name" placeholder="Ex : Atelier de prototypage" required>
          </label>

          <div class="form-row">
          <label class="form-field">
            <span>Semaine (1 √† 5)</span>
            <select id="week-select">
              <option value="1">Semaine 1</option>
              <option value="2">Semaine 2</option>
              <option value="3">Semaine 3</option>
              <option value="4">Semaine 4</option>
              <option value="5">Semaine 5</option>
            </select>
          </label>
          <label class="form-field">
            <span>Demi-jour</span>
            <select id="slot-select">
              <option value="0">Matin</option>
              <option value="1">Apr√®s-midi</option>
            </select>
          </label>
        </div>

        <label class="form-field">
          <span>Format</span>
          <select id="type-select">
            <option value="presentation">Pr√©sentation</option>
            <option value="exercice">Exercice</option>
            <option value="travail_de_groupe">Travail de groupe</option>
            <option value="jeu">Jeu</option>
            <option value="recherche_information">Recherche d'information</option>
            <option value="synthese">Synth√®se</option>
            <option value="evaluation">√âvaluation</option>
          </select>
        </label>

        <label class="form-field">
          <span>Dur√©e (minutes)</span>
          <input type="number" id="duration" min="1" max="480" value="60" required>
        </label>

        <label class="form-field">
          <span>D√©tails (facultatif)</span>
          <textarea id="details" rows="3" placeholder="Objectifs, mat√©riel, format, etc."></textarea>
        </label>

        <label class="form-field">
          <span>Mat√©riel (facultatif)</span>
          <textarea id="materials" rows="2" placeholder="Listez les ressources utiles"></textarea>
        </label>

        <button class="btn btn-primary" type="submit">Ajouter l'activit√©</button>
        <p class="muted" id="status" aria-live="polite"></p>
      </form>

        <div class="timeline" aria-live="polite" aria-label="Planning des 5 semaines">
          <div class="timeline__header">
            <div>
              <p class="label">Planning</p>
              <h3>5 semaines, 2 demi-jours</h3>
              <p class="muted">Chaque carte repr√©sente une semaine. Ajoutez vos activit√©s pour remplir les cr√©neaux.</p>
            </div>
            <div class="legend">
              <span class="legend__item"><span class="dot dot--empty"></span>Libre</span>
              <span class="legend__item"><span class="dot dot--filled"></span>Planifi√©</span>
            </div>
          </div>
          <div class="timeline__grid" id="timeline"></div>
        </div>
      </div>
    </section>

    <section class="section section--cta">
      <div>
        <div class="section__title">Pr√™t √† lancer votre premi√®re vitrine ?</div>
        <p class="section__subtitle">D√©ployez cette page d'accueil en Node.js en quelques secondes et personnalisez-la selon vos couleurs.</p>
      </div>
      <a class="btn btn-primary" href="#">Commencer maintenant</a>
    </section>
  </main>

  <footer class="footer">
    <p>Cr√©√© pour vous par l'√©quipe Coursio.</p>
  </footer>

  <script>
    const weeks = 5;
    const slotLabels = ['Matin', 'Apr√®s-midi'];
    const supportedFormats = {
      presentation: 'Pr√©sentation',
      exercice: 'Exercice',
      travail_de_groupe: 'Travail de groupe',
      jeu: 'Jeu',
      recherche_information: "Recherche d'information",
      synthese: 'Synth√®se',
      evaluation: '√âvaluation'
    };

    const schedule = Array.from({ length: weeks }, (_, index) => ({
      week: index + 1,
      slots: slotLabels.map(label => ({ label, activities: [] }))
    }));

    const timeline = document.getElementById('timeline');
    const form = document.getElementById('activity-form');
    const dbStatus = document.getElementById('db-status');
    const dbStatusDot = document.getElementById('db-status-dot');
    const dbStatusText = document.getElementById('db-status-text');
    let draggedActivity = null;
    let dropHandled = false;

    function setDbStatus(state, message) {
      dbStatus.dataset.state = state;
      dbStatusDot.className = `status-dot status-dot--${state}`;
      dbStatusText.textContent = message;
    }

    async function refreshDbStatus() {
      setDbStatus('checking', 'V√©rification de la connexion √† la base...');

      try {
        const response = await fetch('/api/status');

        if (!response.ok) {
          throw new Error();
        }

        const payload = await response.json();
        if (payload.database) {
          setDbStatus('ok', 'Connexion √† la base de donn√©es √©tablie.');
        } else {
          setDbStatus('error', 'Base de donn√©es inaccessible.');
        }
      } catch (error) {
        setDbStatus('error', 'Base de donn√©es inaccessible.');
      }
    }

    function handleDragStart(event) {
      const { week, slot, index } = event.currentTarget.dataset;
      draggedActivity = {
        week: Number(week),
        slot: Number(slot),
        index: Number(index)
      };
      dropHandled = false;
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', '');
      event.currentTarget.classList.add('is-dragging');
    }

    function handleDragEnd(event) {
      event.currentTarget.classList.remove('is-dragging');

      if (draggedActivity && !dropHandled) {
        const shouldDelete = window.confirm("Voulez-vous supprimer cette activit√© ?");
        if (shouldDelete) {
          const sourceSlot = schedule[draggedActivity.week].slots[draggedActivity.slot];
          sourceSlot.activities.splice(draggedActivity.index, 1);
          renderSchedule();
        }
      }

      draggedActivity = null;
      dropHandled = false;
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(event) {
      event.currentTarget.classList.add('slot__content--over');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('slot__content--over');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('slot__content--over');

      if (!draggedActivity) return;

      dropHandled = true;

      const targetWeek = Number(event.currentTarget.dataset.week);
      const targetSlot = Number(event.currentTarget.dataset.slot);

      if (draggedActivity.week === targetWeek && draggedActivity.slot === targetSlot) return;

      const sourceSlot = schedule[draggedActivity.week].slots[draggedActivity.slot];
      const [activity] = sourceSlot.activities.splice(draggedActivity.index, 1);
      schedule[targetWeek].slots[targetSlot].activities.push(activity);

      draggedActivity = null;
      renderSchedule();
    }

    function createActivityElement(activity, weekIndex, slotIndex, activityIndex) {
      const activityEl = document.createElement('div');
      activityEl.className = 'activity';
      activityEl.draggable = true;
      activityEl.dataset.week = weekIndex;
      activityEl.dataset.slot = slotIndex;
      activityEl.dataset.index = activityIndex;
      activityEl.innerHTML = `
        <div class="activity__header">
          <span class="activity__title">${activity.name}</span>
          <span class="activity__type">${activity.type}</span>
        </div>
        ${activity.details ? `<p class="activity__details">${activity.details}</p>` : ''}
      `;

      activityEl.addEventListener('dragstart', handleDragStart);
      activityEl.addEventListener('dragend', handleDragEnd);

      return activityEl;
    }

    function createSlotContent(weekIndex, slotIndex, slot) {
      const slotContent = document.createElement('div');
      slotContent.className = 'slot__content';
      slotContent.dataset.week = weekIndex;
      slotContent.dataset.slot = slotIndex;
      slotContent.addEventListener('dragover', handleDragOver);
      slotContent.addEventListener('dragenter', handleDragEnter);
      slotContent.addEventListener('dragleave', handleDragLeave);
      slotContent.addEventListener('drop', handleDrop);

      if (slot.activities.length === 0) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'Aucune activit√© planifi√©e';
        slotContent.appendChild(empty);
      } else {
        slot.activities.forEach((activity, activityIndex) => {
          slotContent.appendChild(createActivityElement(activity, weekIndex, slotIndex, activityIndex));
        });
      }

      return slotContent;
    }

    function renderSchedule() {
      timeline.innerHTML = schedule.map(week => {
        const slots = week.slots.map(slot => {
          const hasActivities = slot.activities.length > 0;
          const items = hasActivities
            ? slot.activities.map(activity => `
                <div class="activity">
                  <div class="activity__header">
                    <span class="activity__title">${activity.name}</span>
                    <span class="activity__type">${supportedFormats[activity.type]}</span>
                  </div>
                  <p class="activity__details">${activity.duration} min ‚Ä¢ ${activity.details || 'Description √† compl√©ter'}</p>
                  ${activity.materials ? `<p class="activity__details">Mat√©riel : ${activity.materials}</p>` : ''}
                </div>
              `).join('')
            : '<p class="empty">Aucune activit√© planifi√©e</p>';

          return `
            <div class="slot ${hasActivities ? 'slot--filled' : ''}">
              <div class="slot__label">${slot.label}</div>
              <div class="slot__content">${items}</div>
            </div>
          `;
        }).join('');

        return `
          <article class="week-card">
            <header>
              <p class="label">Semaine ${week.week}</p>
              <p class="muted">2 demi-jours pr√™ts √† accueillir vos activit√©s</p>
            </header>
            <div class="slots">${slots}</div>
          </article>
        `;

        const slotsContainer = document.createElement('div');
        slotsContainer.className = 'slots';

        week.slots.forEach((slot, slotIndex) => {
          const slotWrapper = document.createElement('div');
          const hasActivities = slot.activities.length > 0;

          slotWrapper.className = `slot ${hasActivities ? 'slot--filled' : ''}`;

          const slotLabel = document.createElement('div');
          slotLabel.className = 'slot__label';
          slotLabel.textContent = slot.label;

          slotWrapper.appendChild(slotLabel);
          slotWrapper.appendChild(createSlotContent(weekIndex, slotIndex, slot));
          slotsContainer.appendChild(slotWrapper);
        });

        weekCard.appendChild(header);
        weekCard.appendChild(slotsContainer);
        timeline.appendChild(weekCard);
      });
    }

    async function persistActivity(payload) {
      try {
        const response = await fetch('/api/activities', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Sauvegarde impossible');
        }

        status.textContent = 'Activit√© enregistr√©e dans la base MariaDB.';
      } catch (error) {
        status.textContent = `‚ö†Ô∏è ${error.message}`;
      }
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();

      const name = document.getElementById('activity-name').value.trim();
      const weekIndex = Number(document.getElementById('week-select').value) - 1;
      const slotIndex = Number(document.getElementById('slot-select').value);
      const type = document.getElementById('type-select').value;
      const duration = Number(document.getElementById('duration').value) || 0;
      const details = document.getElementById('details').value.trim();
      const materials = document.getElementById('materials').value.trim();

      if (!name || duration <= 0) return;

      const targetSlot = schedule[weekIndex].slots[slotIndex];
      const activity = { name, type, details, duration, materials };
      targetSlot.activities.push(activity);

      status.textContent = 'Enregistrement de l‚Äôactivit√© en cours...';
      persistActivity({
        name,
        week: weekIndex + 1,
        slot: slotIndex,
        format: type,
        details,
        duration,
        materials
      });

      renderSchedule();
      form.reset();
      document.getElementById('duration').value = 60;
      document.getElementById('week-select').value = weekIndex + 1;
      document.getElementById('slot-select').value = slotIndex;
    });

    refreshDbStatus();
    renderSchedule();
  </script>
</body>
</html>
