<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coursio | Accueil</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="auth-overlay is-hidden" id="auth-overlay" role="dialog" aria-modal="true" aria-labelledby="auth-title" hidden>
    <div class="auth-card">
      <div class="auth-card__header">
        <p class="label" id="auth-title">Bienvenue sur Coursio</p>
        <p class="muted" id="auth-subtitle">Connectez-vous pour accéder à votre espace enseignant.</p>
      </div>
      <div class="auth-tabs">
        <button class="auth-tab is-active" id="tab-login" type="button">Connexion</button>
        <button class="auth-tab" id="tab-register" type="button" aria-disabled="true" title="La création de compte est désactivée">Créer un compte</button>
      </div>
      <form class="auth-form" id="login-form">
        <label class="form-field">
          <span>Email</span>
          <input type="email" id="login-email" autocomplete="username" required>
        </label>
        <label class="form-field">
          <span>Mot de passe</span>
          <input type="password" id="login-password" autocomplete="current-password" required>
        </label>
        <button class="btn btn-primary" type="submit">Se connecter</button>
      </form>

      <form class="auth-form is-hidden" id="register-form" aria-hidden="true">
        <label class="form-field">
          <span>Nom complet</span>
          <input type="text" id="register-name" autocomplete="name" required disabled>
        </label>
        <label class="form-field">
          <span>Email</span>
          <input type="email" id="register-email" autocomplete="email" required disabled>
        </label>
        <label class="form-field">
          <span>Mot de passe</span>
          <input type="password" id="register-password" autocomplete="new-password" minlength="8" required disabled>
        </label>
        <p class="muted">La création de compte est actuellement désactivée. Contactez votre administrateur pour obtenir un accès.</p>
        <button class="btn btn-primary" type="submit" disabled>Créer mon compte</button>
      </form>

      <p class="muted" id="auth-status" aria-live="polite"></p>
    </div>
  </div>

  <main class="sections">
    <section class="section planner" id="demo">
      <div class="planner__header">
        <div class="planner__intro">
          <div class="section__title">CoursIO - Planificateur de cours</div>
          <p class="section__subtitle"></p>
        </div>
        <div class="session-banner planner__session" id="session-banner" hidden>
          <p class="label">Connecté en tant que</p>
          <p class="muted" id="session-user"></p>
          <button class="btn btn-ghost" id="logout-button" type="button">Se déconnecter</button>
        </div>
      </div>

      <div class="course-toolbar" aria-label="Sélection des cours">
        <div class="course-toolbar__intro">
          <button class="label course-title" id="course-title" type="button">Sélectionnez un module</button>
          <div class="muted course-details" id="course-details">Connectez-vous pour afficher les informations de votre cours.</div>
        </div>
        <div class="course-toolbar__actions">
          <label class="form-field form-field--inline">
            <span>Cours disponibles</span>
            <select id="course-select"></select>
          </label>
          <button class="icon-button" id="open-course-modal" type="button" aria-haspopup="dialog">
            <span aria-hidden="true">+</span>
            <span class="sr-only">Créer un nouveau cours</span>
          </button>
        </div>
      </div>

      <div class="course-editor is-hidden" id="course-editor" hidden>
        <form class="course-editor__form" id="course-editor-form">
          <div class="form-row">
            <label class="form-field">
              <span>Numéro du module</span>
              <input type="text" id="edit-course-number" required>
            </label>
            <label class="form-field">
              <span>Titre du cours</span>
              <input type="text" id="edit-course-name" required>
            </label>
          </div>
          <div class="form-row">
            <label class="form-field">
              <span>Classe</span>
              <input type="text" id="edit-course-class" required>
            </label>
            <label class="form-field">
              <span>Salle</span>
              <input type="text" id="edit-course-room" required>
            </label>
          </div>
          <label class="form-field">
            <span>Particularités</span>
            <textarea id="edit-course-particularities" rows="2" placeholder="Précisions logistiques, modalités, etc."></textarea>
          </label>
          <div class="course-editor__actions">
            <div class="course-editor__action-buttons">
              <button class="btn btn-primary" type="submit">Mettre à jour</button>
              <button class="btn btn-danger" type="button" id="course-editor-delete">Supprimer le cours</button>
            </div>
            <button class="btn btn-ghost" type="button" id="course-editor-cancel">Fermer</button>
          </div>
          <p class="muted" id="course-editor-status"></p>
        </form>
      </div>

        <div class="planner__grid">
          <div class="timeline" aria-live="polite" aria-label="Planning des 5 semaines">
            <div class="timeline__header">
              <div>
                <p class="label">Planning</p>
              </div>
            </div>
            <div class="timeline__grid" id="timeline"></div>
          </div>
        </div>
      </section>

  </main>

  <div class="activity-modal is-hidden" id="activity-modal" role="dialog" aria-modal="true" aria-labelledby="activity-modal-title" hidden>
    <div class="activity-modal__backdrop" data-close-activity-modal></div>
    <div class="activity-modal__content">
      <div class="activity-modal__header">
        <div>
          <p class="label" id="activity-modal-title">Nouvelle activité</p>
          <p class="muted">Renseignez les détails pour l’ajouter au planning.</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-activity-modal" type="button" aria-label="Fermer le formulaire">×</button>
      </div>

      <form class="activity-form" id="activity-form">
        <label class="form-field">
          <span>Nom de l'activité</span>
          <input type="text" id="activity-name" placeholder="Ex : Atelier de prototypage" required>
        </label>

        <label class="form-field">
          <span>Format</span>
          <input type="hidden" id="type-select" value="presentation">
          <div class="format-selector" id="format-selector" role="group" aria-label="Choisir un format">
            <button class="format-chip is-selected" type="button" data-format="presentation" title="Présentation" aria-label="Présentation" aria-pressed="true">
              <span class="format-chip__icon" data-format-icon="presentation" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="exercice" title="Exercice" aria-label="Exercice" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="exercice" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="travail_de_groupe" title="Travail de groupe" aria-label="Travail de groupe" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="travail_de_groupe" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="jeu" title="Jeu" aria-label="Jeu" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="jeu" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="recherche_information" title="Recherche d'information" aria-label="Recherche d'information" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="recherche_information" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="synthese" title="Synthèse" aria-label="Synthèse" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="synthese" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="evaluation" title="Évaluation" aria-label="Évaluation" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="evaluation" aria-hidden="true"></span>
            </button>
          </div>
        </label>

        <label class="form-field">
          <span>Durée (minutes)</span>
          <input type="number" id="duration" min="1" max="480" value="60" required>
        </label>

        <label class="form-field">
          <span>Détails (facultatif)</span>
          <textarea id="details" rows="3" placeholder="Objectifs, matériel, format, etc."></textarea>
        </label>

        <label class="form-field">
          <span>Matériel (facultatif)</span>
          <textarea id="materials" rows="2" placeholder="Listez les ressources utiles"></textarea>
        </label>

        <div class="course-form__actions activity-form__actions">
          <div class="activity-form__buttons">
            <button class="btn btn-primary" id="activity-submit" type="submit">Ajouter l'activité</button>
            <button class="btn btn-danger is-hidden" id="delete-activity" type="button">Supprimer</button>
          </div>
          <p class="muted" id="activity-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <div class="course-modal is-hidden" id="course-modal" role="dialog" aria-modal="true" aria-labelledby="course-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-course-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="course-modal-title">Nouveau cours</p>
          <p class="muted">Renseignez les informations principales pour le créer.</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-course-modal" type="button" aria-label="Fermer le formulaire">×</button>
      </div>

      <form class="course-form" id="course-form">
        <div class="form-row">
          <div class="form-field form-field--static">
            <span>Enseignant</span>
            <p id="course-teacher" class="form-static">—</p>
          </div>
          <label class="form-field">
            <span>Classe</span>
            <input type="text" id="course-class" placeholder="Ex : BTS SIO" required>
          </label>
        </div>
        <div class="form-row">
          <label class="form-field">
            <span>Salle</span>
            <input type="text" id="course-room" placeholder="Ex : Salle 204" required>
          </label>
          <label class="form-field">
            <span>Module</span>
            <input type="text" id="course-number" placeholder="Ex : MOD-101" required>
          </label>
        </div>
        <label class="form-field">
          <span>Titre du module</span>
          <input type="text" id="course-name" placeholder="Nom du module" required>
        </label>
        <label class="form-field">
          <span>Particularités</span>
          <textarea id="course-particularities" rows="2" placeholder="Précisions logistiques, modalités, etc."></textarea>
        </label>
        <div class="form-row">
          <label class="form-field">
            <span>Date de début</span>
            <input type="date" id="course-start-date" required>
          </label>
          <label class="form-field">
            <span>Demi-journée de début</span>
            <select id="course-start-slot">
              <option value="0">Matin</option>
              <option value="1">Après-midi</option>
            </select>
          </label>
        </div>
        <div class="course-form__actions">
          <button class="btn btn-primary" type="submit">Créer le cours</button>
          <p class="muted" id="course-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <div class="course-modal reschedule-modal is-hidden" id="reschedule-modal" role="dialog" aria-modal="true" aria-labelledby="reschedule-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-reschedule-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="reschedule-modal-title">Replanifier la semaine</p>
          <p class="muted" id="reschedule-week-title">Semaine 1</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-reschedule-modal" type="button" aria-label="Fermer le recalcul des dates">×</button>
      </div>

      <form class="course-form" id="reschedule-form">
        <label class="form-field">
          <span>Nouvelle date de début</span>
          <input type="date" id="reschedule-date" required>
        </label>
        <p class="muted">La date et les demi-journées suivantes seront recalculées pour cette semaine.</p>
        <div class="course-form__actions">
          <div class="activity-form__buttons">
            <button class="btn btn-primary" type="submit">Mettre à jour</button>
            <button class="btn btn-ghost" type="button" id="cancel-reschedule">Annuler</button>
          </div>
          <p class="muted" id="reschedule-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <div class="course-modal is-hidden" id="half-day-modal" role="dialog" aria-modal="true" aria-labelledby="half-day-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-half-day-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="half-day-modal-title">Configurer la demi-journée</p>
          <p class="muted" id="half-day-title">—</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-half-day-modal" type="button" aria-label="Fermer la configuration de la demi-journée">×</button>
      </div>

      <form class="course-form" id="half-day-form">
        <label class="form-field form-field--inline">
          <span>État de la demi-journée</span>
          <div class="half-day-toggle">
            <button class="toggle-button" type="button" id="half-day-holiday" aria-pressed="false">
              <span class="toggle-button__track" aria-hidden="true">
                <span class="toggle-button__thumb"></span>
              </span>
              <span class="toggle-button__state" data-holiday-state>OFF</span>
            </button>
            <span>Marquer cette demi-journée comme congé</span>
          </div>
        </label>

        <div class="course-form__actions">
          <button class="btn btn-primary" type="submit">Enregistrer</button>
          <button class="btn btn-ghost" type="button" id="cancel-half-day">Annuler</button>
        </div>
        <p class="muted" id="half-day-status" aria-live="polite"></p>
      </form>
    </div>
  </div>
  <script>
    const weeks = 5;
    const supportedFormats = {
      presentation: 'Présentation',
      exercice: 'Exercice',
      travail_de_groupe: 'Travail de groupe',
      jeu: 'Jeu',
      recherche_information: "Recherche d'information",
      synthese: 'Synthèse',
      evaluation: 'Évaluation'
    };

    const formatIcons = {
      presentation: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h16v8H4z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="m12 15 3.5 4m-3.5-4-3.5 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M16 10.5 8 9v3l8-1.5Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>`,
      exercice: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="6" height="6" rx="1.2" fill="none" stroke="currentColor" stroke-width="1.6"/><rect x="14" y="14" width="6" height="6" rx="1.2" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="m10 10 4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      travail_de_groupe: `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="9" cy="9" r="3" fill="none" stroke="currentColor" stroke-width="1.6"/><circle cx="15" cy="9" r="3" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M4.5 18c.6-2.1 2.6-3.5 4.8-3.5 2.2 0 4.1 1.4 4.7 3.4m2.7-3.2c1.9 0 3.4 1.3 3.8 3.3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      jeu: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="1.6"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/><circle cx="9" cy="15" r="1" fill="currentColor"/><circle cx="15" cy="15" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>`,
      recherche_information: `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="5" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="m14.5 14.5 4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      synthese: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="12" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M9 9h6M9 13h6M9 17h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      evaluation: `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="m9 12.5 2 2.5 4-5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`
    };

    const dateFormatter = new Intl.DateTimeFormat('fr-FR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });

    function formatHalfDayLabel(halfDay) {
      const periodLabel = halfDay.period === 'apres_midi' ? 'Après-midi' : 'Matin';
      const formattedDate = dateFormatter.format(new Date(halfDay.sessionDate));
      return `${formattedDate} • ${periodLabel}`;
    }

    function buildSchedule(halfDays = [], holidays = {}) {
      const weeksSchedule = Array.from({ length: weeks }, (_, index) => ({
        week: index + 1,
        slots: Array.from({ length: 3 }, (__, slotIndex) => ({
          label: `Créneau ${slotIndex + 1}`,
          activities: [],
          isHoliday: Boolean(holidays[`${index + 1}-${slotIndex}`])
        }))
      }));

      halfDays.forEach((halfDay) => {
        const weekIndex = halfDay.weekNumber - 1;
        const slotIndex = halfDay.slotIndex;

        if (!weeksSchedule[weekIndex] || !weeksSchedule[weekIndex].slots[slotIndex]) return;

        const key = `${halfDay.weekNumber}-${halfDay.slotIndex}`;
        const isHoliday = Boolean(holidays[key]);

        weeksSchedule[weekIndex].slots[slotIndex] = {
          label: formatHalfDayLabel(halfDay),
          activities: [],
          isHoliday
        };
      });

      return weeksSchedule;
    }

    function createEmptySchedule() {
      return buildSchedule();
    }

    function isValidDateInput(value) {
      if (typeof value !== 'string') return false;

      const parsed = new Date(value);
      return !Number.isNaN(parsed.getTime()) && parsed.toISOString().slice(0, 10) === value;
    }

    function getWeekStartDate(weekNumber) {
      const startingHalfDay = courseHalfDays.find(
        (halfDay) => halfDay.weekNumber === weekNumber && halfDay.slotIndex === 0
      );

      return startingHalfDay?.sessionDate || '';
    }

    function getHolidayStorageKey(courseId) {
      return `coursio-holidays-${courseId}`;
    }

    function loadHolidayOverrides(courseId) {
      if (!courseId) return {};

      try {
        const storedValue = localStorage.getItem(getHolidayStorageKey(courseId));
        return storedValue ? JSON.parse(storedValue) : {};
      } catch (error) {
        console.warn('Impossible de charger les congés locaux :', error.message);
        return {};
      }
    }

    function persistHolidayOverrides(courseId, overrides) {
      if (!courseId) return;

      try {
        localStorage.setItem(getHolidayStorageKey(courseId), JSON.stringify(overrides));
      } catch (error) {
        console.warn('Impossible de sauvegarder les congés locaux :', error.message);
      }
    }

    let schedule = buildSchedule();
    let courseHalfDays = [];
    let rescheduleWeekIndex = null;
    let halfDaySelection = { weekIndex: null, slotIndex: null };
    let halfDayHolidays = {};

    const timeline = document.getElementById('timeline');
    const authOverlay = document.getElementById('auth-overlay');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const tabLogin = document.getElementById('tab-login');
    const tabRegister = document.getElementById('tab-register');
    const authStatus = document.getElementById('auth-status');
    const sessionBanner = document.getElementById('session-banner');
    const sessionUser = document.getElementById('session-user');
    const logoutButton = document.getElementById('logout-button');
    const courseTeacherDisplay = document.getElementById('course-teacher');
    const activityForm = document.getElementById('activity-form');
    const activityModal = document.getElementById('activity-modal');
    const activityModalBackdrop = document.querySelector('[data-close-activity-modal]');
    const activityStatus = document.getElementById('activity-status');
    const activityModalTitle = document.getElementById('activity-modal-title');
    const activitySubmitButton = document.getElementById('activity-submit');
    const activityDeleteButton = document.getElementById('delete-activity');
    const formatSelector = document.getElementById('format-selector');
    const formatInput = document.getElementById('type-select');
    const closeActivityModalBtn = document.getElementById('close-activity-modal');
    const courseForm = document.getElementById('course-form');
    const courseModal = document.getElementById('course-modal');
    const courseSelect = document.getElementById('course-select');
    const courseTitleButton = document.getElementById('course-title');
    const courseDetails = document.getElementById('course-details');
    const courseStatus = document.getElementById('course-status');
    const courseStartDateInput = document.getElementById('course-start-date');
    const courseStartSlotSelect = document.getElementById('course-start-slot');
    const courseParticularitiesInput = document.getElementById('course-particularities');
    const courseEditor = document.getElementById('course-editor');
    const courseEditorForm = document.getElementById('course-editor-form');
    const courseEditorStatus = document.getElementById('course-editor-status');
    const courseEditorDeleteButton = document.getElementById('course-editor-delete');
    const courseEditorCancelButton = document.getElementById('course-editor-cancel');
    const editCourseNumberInput = document.getElementById('edit-course-number');
    const editCourseNameInput = document.getElementById('edit-course-name');
    const editCourseClassInput = document.getElementById('edit-course-class');
    const editCourseRoomInput = document.getElementById('edit-course-room');
    const editCourseParticularitiesInput = document.getElementById('edit-course-particularities');
    const closeCourseModalBtn = document.getElementById('close-course-modal');
    const courseModalBackdrop = document.querySelector('[data-close-course-modal]');
    const openCourseModalBtn = document.getElementById('open-course-modal');
    const rescheduleModal = document.getElementById('reschedule-modal');
    const rescheduleModalBackdrop = document.querySelector('[data-close-reschedule-modal]');
    const closeRescheduleModalBtn = document.getElementById('close-reschedule-modal');
    const rescheduleForm = document.getElementById('reschedule-form');
    const rescheduleDateInput = document.getElementById('reschedule-date');
    const rescheduleStatus = document.getElementById('reschedule-status');
    const rescheduleWeekTitle = document.getElementById('reschedule-week-title');
    const cancelRescheduleButton = document.getElementById('cancel-reschedule');
    const halfDayModal = document.getElementById('half-day-modal');
    const halfDayModalBackdrop = document.querySelector('[data-close-half-day-modal]');
    const closeHalfDayModalBtn = document.getElementById('close-half-day-modal');
    const halfDayForm = document.getElementById('half-day-form');
    const halfDayHolidayToggle = document.getElementById('half-day-holiday');
    const halfDayTitle = document.getElementById('half-day-title');
    const halfDayStatus = document.getElementById('half-day-status');
    const cancelHalfDayButton = document.getElementById('cancel-half-day');
    const loginEmailInput = document.getElementById('login-email');
    const registerNameInput = document.getElementById('register-name');
    const registerEmailInput = document.getElementById('register-email');
    const registerPasswordInput = document.getElementById('register-password');
    const loginPasswordInput = document.getElementById('login-password');
    const registrationDisabledMessage = 'La création de compte est désactivée. Contactez votre administrateur pour obtenir un accès.';
    let coursesCache = [];
    let draggedActivity = null;
    let dropHandled = false;
    let currentCourseId = null;
    let editingActivity = null;
    let creationWeekIndex = null;
    let currentUser = null;

    function showAuthOverlay(mode = 'login', message = '') {
      const statusMessage = message || (mode === 'register' ? registrationDisabledMessage : '');
      authStatus.textContent = statusMessage;
      authOverlay.classList.remove('is-hidden');
      authOverlay.removeAttribute('hidden');

      loginForm.classList.remove('is-hidden');
      registerForm.classList.add('is-hidden');
      tabLogin.classList.add('is-active');
      tabRegister.classList.remove('is-active');
      loginEmailInput.focus();
    }

    function hideAuthOverlay() {
      authOverlay.classList.add('is-hidden');
      authOverlay.setAttribute('hidden', '');
      authStatus.textContent = '';
    }

    function updateSessionBanner() {
      if (!currentUser) {
        sessionBanner.setAttribute('hidden', '');
        sessionUser.textContent = '';
        courseTeacherDisplay.textContent = '—';
        return;
      }

      sessionUser.textContent = `${currentUser.displayName || currentUser.name} (${currentUser.email})`;
      courseTeacherDisplay.textContent = currentUser.displayName || currentUser.name;
      sessionBanner.removeAttribute('hidden');
    }

    function setCurrentUser(user) {
      currentUser = user;
      updateSessionBanner();
      if (!user) {
        coursesCache = [];
        currentCourseId = null;
        updateCourseHeader();
        closeCourseEditor();
      }
    }

    function handleUnauthorized(message = 'Connectez-vous pour continuer.') {
      setCurrentUser(null);
      showAuthOverlay('login', message);
    }

    async function authorizedFetch(url, options = {}) {
      const response = await fetch(url, options);
      if (response.status === 401) {
        handleUnauthorized('Votre session a expiré.');
        throw new Error('UNAUTHORIZED');
      }
      return response;
    }

    function getFormatIconMarkup(format) {
      return formatIcons[format] || formatIcons.presentation;
    }

    function renderFormatIcons() {
      document.querySelectorAll('[data-format-icon]').forEach((iconEl) => {
        const format = iconEl.dataset.formatIcon;
        iconEl.innerHTML = getFormatIconMarkup(format);
      });
    }

    function buildCourseDetails(course) {
      if (!course) {
        return [];
      }

      const startPeriodLabel = course.startPeriod === 'apres_midi' ? 'Après-midi' : 'Matin';
      const startLabel = course.startDate ? `${course.startDate} (${startPeriodLabel})` : 'Date de début inconnue';

      return [
        { label: 'Classe', value: course.className || 'Non précisée' },
        { label: 'Salle', value: course.room || 'Non précisée' },
        { label: 'Début', value: startLabel },
        { label: 'Particularités', value: course.particularites?.trim() || 'Aucune précision' }
      ];
    }

    function renderCourseDetails(course) {
      if (!courseDetails) return;

      courseDetails.innerHTML = '';

      if (!course) {
        courseDetails.textContent = 'Choisissez ou créez un cours pour gérer vos activités.';
        return;
      }

      const detailRows = buildCourseDetails(course);

      detailRows.forEach(({ label, value }) => {
        const row = document.createElement('div');
        row.className = 'course-detail-row';

        const rowLabel = document.createElement('span');
        rowLabel.className = 'course-detail-label';
        rowLabel.textContent = label;

        const rowValue = document.createElement('span');
        rowValue.className = 'course-detail-value';
        rowValue.textContent = value;

        row.append(rowLabel, rowValue);
        courseDetails.appendChild(row);
      });
    }

    function updateCourseHeader(course = getCurrentCourse()) {
      if (!courseTitleButton || !courseDetails) return;

      if (!course) {
        courseTitleButton.textContent = 'Sélectionnez un module';
        renderCourseDetails(null);
        courseTitleButton.setAttribute('aria-disabled', 'true');
        return;
      }

      courseTitleButton.textContent = `${course.moduleNumber} · ${course.moduleName}`;
      courseTitleButton.removeAttribute('aria-disabled');
      renderCourseDetails(course);
    }

    function selectFormat(format) {
      if (!formatSelector) return;

      formatInput.value = format;
      formatSelector.querySelectorAll('.format-chip').forEach((button) => {
        const isSelected = button.dataset.format === format;
        button.classList.toggle('is-selected', isSelected);
        button.setAttribute('aria-pressed', String(isSelected));
      });
    }

    function initializeFormatSelector() {
      if (!formatSelector) return;

      formatSelector.querySelectorAll('.format-chip').forEach((button) => {
        button.addEventListener('click', () => selectFormat(button.dataset.format));
      });

      selectFormat(formatInput.value || Object.keys(supportedFormats)[0]);
    }

    function setActivityFormMode(mode) {
      if (mode === 'edit') {
        activitySubmitButton.textContent = "Modifier l'activité";
        activityModalTitle.textContent = 'Modifier une activité';
        activityDeleteButton.classList.remove('is-hidden');
        return;
      }

      editingActivity = null;
      activitySubmitButton.textContent = "Ajouter l'activité";
      activityModalTitle.textContent = 'Nouvelle activité';
      activityDeleteButton.classList.add('is-hidden');
    }

    function resetActivityFormDefaults() {
      activityForm.reset();
      document.getElementById('duration').value = 60;
      selectFormat('presentation');
    }

    function openActivityModal(weekIndex) {
      const availableSlotIndex = findNextSlotIndex(weekIndex);
      if (availableSlotIndex === null) {
        activityStatus.textContent = 'Cette semaine est configurée en congé. Retirez le congé pour ajouter une activité.';
        return;
      }

      creationWeekIndex = weekIndex;
      setActivityFormMode('create');
      resetActivityFormDefaults();
      activityStatus.textContent = '';
      activityModal.removeAttribute('hidden');
      activityModal.classList.remove('is-hidden');
      document.getElementById('activity-name').focus();
    }

    function closeActivityModal() {
      creationWeekIndex = null;
      activityModal.setAttribute('hidden', '');
      activityModal.classList.add('is-hidden');
      setActivityFormMode('create');
    }

    function openActivityEditModal(activity, weekIndex, slotIndex, activityIndex) {
      if (!activity) return;

      creationWeekIndex = weekIndex;
      editingActivity = { id: activity.id, weekIndex, slotIndex, activityIndex };
      setActivityFormMode('edit');

      document.getElementById('activity-name').value = activity.name;
      document.getElementById('duration').value = activity.duration;
      document.getElementById('details').value = activity.details || '';
      document.getElementById('materials').value = activity.materials || '';

      selectFormat(activity.type);

      activityStatus.textContent = '';
      activityModal.removeAttribute('hidden');
      activityModal.classList.remove('is-hidden');
      document.getElementById('activity-name').focus();
    }

    function openCourseModal() {
      if (!currentUser) {
        showAuthOverlay('login', 'Connectez-vous pour créer un cours.');
        return;
      }

      courseForm.reset();
      courseStatus.textContent = '';
      courseModal.removeAttribute('hidden');
      courseModal.classList.remove('is-hidden');
      courseStartDateInput.value = new Date().toISOString().slice(0, 10);
      courseStartSlotSelect.value = 0;
      courseTeacherDisplay.textContent = currentUser?.displayName || currentUser?.name || '—';
      document.getElementById('course-class').focus();
    }

    function closeCourseModal() {
      courseModal.setAttribute('hidden', '');
      courseModal.classList.add('is-hidden');
    }

    function closeCourseEditor() {
      if (!courseEditor) return;
      courseEditor.classList.add('is-hidden');
      courseEditor.hidden = true;
      courseEditorStatus.textContent = '';
    }

    function openCourseEditor() {
      if (!currentUser) {
        showAuthOverlay('login', 'Connectez-vous pour modifier un cours.');
        return;
      }

      const course = getCurrentCourse();

      if (!course) {
        courseStatus.textContent = 'Sélectionnez un cours à modifier.';
        return;
      }

      courseEditorStatus.textContent = '';
      editCourseNumberInput.value = course.moduleNumber || '';
      editCourseNameInput.value = course.moduleName || '';
      editCourseClassInput.value = course.className || '';
      editCourseRoomInput.value = course.room || '';
      editCourseParticularitiesInput.value = course.particularites || '';

      courseEditor.classList.remove('is-hidden');
      courseEditor.hidden = false;
      editCourseNumberInput.focus();
    }

    function fillCourseSelect(courses) {
      coursesCache = courses;
      courseSelect.innerHTML = '';

      courses.forEach((course) => {
        const option = document.createElement('option');
        option.value = course.id;
        option.textContent = `${course.moduleNumber} — ${course.moduleName}`;
        option.dataset.moduleNumber = course.moduleNumber;
        courseSelect.appendChild(option);
      });

      const hasCurrentSelection = courses.some((course) => course.id === currentCourseId);

      if (!hasCurrentSelection) {
        currentCourseId = courses[0]?.id ?? null;
      }

      if (currentCourseId) {
        courseSelect.value = currentCourseId;
      }

      updateCourseHeader();
    }

    async function loadCourses() {
      if (!currentUser) {
        courseStatus.textContent = 'Connectez-vous pour afficher vos cours.';
        updateCourseHeader(null);
        return;
      }

      courseStatus.textContent = 'Chargement des cours...';

      try {
        const response = await authorizedFetch('/api/courses');
        if (!response.ok) {
          throw new Error();
        }

        const courses = await response.json();
        fillCourseSelect(courses);

        if (courses.length === 0) {
          courseStatus.textContent = 'Aucun cours disponible pour le moment.';
          currentCourseId = null;
          halfDayHolidays = {};
          halfDaySelection = { weekIndex: null, slotIndex: null };
          schedule = createEmptySchedule();
          renderSchedule();
          updateCourseHeader(null);
          return;
        }

        courseStatus.textContent = '';
        currentCourseId = Number(courseSelect.value);
        await loadActivitiesForCourse(currentCourseId);
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = 'Impossible de charger les cours.';
      }
    }

    function getCurrentCourse() {
      return coursesCache.find((course) => course.id === currentCourseId) || null;
    }

    async function deleteCurrentCourse() {
      if (!currentCourseId) {
        courseStatus.textContent = 'Sélectionnez d’abord un cours à supprimer.';
        return;
      }

      const course = getCurrentCourse();
      if (!course) {
        courseStatus.textContent = 'Cours introuvable dans la sélection.';
        return;
      }

      const confirmationMessage =
        `Pour supprimer le cours ${course.moduleNumber} (${course.moduleName}), saisissez son numéro de module. ` +
        'Cette action supprimera aussi tous les demi-jours et activités associés.';

      const userInput = window.prompt(confirmationMessage);

      if (userInput === null) {
        courseStatus.textContent = 'Suppression annulée.';
        return;
      }

      const moduleNumberInput = userInput.trim();

      if (moduleNumberInput !== course.moduleNumber) {
        courseStatus.textContent = 'Le numéro saisi ne correspond pas au cours sélectionné.';
        return;
      }

      courseStatus.textContent = 'Suppression du cours en cours...';

      try {
        const response = await authorizedFetch(`/api/courses/${course.id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ moduleNumber: moduleNumberInput })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Impossible de supprimer le cours.');
        }

        currentCourseId = null;
        courseStatus.textContent = 'Cours supprimé.';
        closeCourseEditor();
        await loadCourses();
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = `⚠️ ${error.message}`;
      }
    }

    async function updateCourseMetadata(payload) {
      if (!currentCourseId) {
        courseEditorStatus.textContent = 'Sélectionnez un cours avant de le modifier.';
        return false;
      }

      courseEditorStatus.textContent = 'Mise à jour du cours en cours...';

      try {
        const response = await authorizedFetch(`/api/courses/${currentCourseId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Impossible de mettre à jour le cours.');
        }

        courseEditorStatus.textContent = 'Cours mis à jour.';
        return true;
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return false;
        courseEditorStatus.textContent = `⚠️ ${error.message}`;
        return false;
      }
    }

    function handleDragStart(event) {
      const { week, slot, index, id } = event.currentTarget.dataset;
      draggedActivity = {
        week: Number(week),
        slot: Number(slot),
        index: Number(index),
        id: Number(id)
      };
      dropHandled = false;
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', '');
      event.currentTarget.classList.add('is-dragging');
    }

    function handleDragEnd(event) {
      event.currentTarget.classList.remove('is-dragging');

      draggedActivity = null;
      dropHandled = false;
    }

    function handleDragOver(event) {
      if (isHolidayTarget(event)) return;
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(event) {
      if (isHolidayTarget(event)) return;
      event.currentTarget.classList.add('slot__content--over');
    }

    function handleDragLeave(event) {
      if (isHolidayTarget(event)) return;
      event.currentTarget.classList.remove('slot__content--over');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('slot__content--over');

      if (!draggedActivity) return;

      dropHandled = true;

      const targetWeek = Number(event.currentTarget.dataset.week);
      const targetSlot = Number(event.currentTarget.dataset.slot);

      const targetSlotData = schedule[targetWeek]?.slots?.[targetSlot];
      if (!targetSlotData || targetSlotData.isHoliday) return;

      if (draggedActivity.week === targetWeek && draggedActivity.slot === targetSlot) return;

      const sourceSlot = schedule[draggedActivity.week].slots[draggedActivity.slot];
      const [activity] = sourceSlot.activities.splice(draggedActivity.index, 1);
      targetSlotData.activities.push(activity);

      moveActivity(draggedActivity.id, targetWeek + 1, targetSlot).catch(() => {
        courseStatus.textContent = '⚠️ Impossible de mettre à jour la base, rechargement du planning...';
        loadActivitiesForCourse(currentCourseId);
      });

      draggedActivity = null;
      renderSchedule();
    }

    function removeActivityFromSchedule(context) {
      const slot = schedule[context.weekIndex]?.slots?.[context.slotIndex];
      if (!slot) return null;

      return slot.activities.splice(context.activityIndex, 1)[0] || null;
    }

    function addActivityToSchedule(activity, weekIndex, slotIndex) {
      const slot = schedule[weekIndex]?.slots?.[slotIndex];
      if (!slot) return;

      slot.activities.push(activity);
    }

    function createActivityElement(activity, weekIndex, slotIndex, activityIndex) {
      const activityEl = document.createElement('div');
      activityEl.className = 'activity';
      activityEl.draggable = true;
      activityEl.dataset.week = weekIndex;
      activityEl.dataset.slot = slotIndex;
      activityEl.dataset.index = activityIndex;
      activityEl.dataset.id = activity.id;

      const header = document.createElement('div');
      header.className = 'activity__header';

      const metaColumn = document.createElement('div');
      metaColumn.className = 'activity__meta';

      const duration = document.createElement('div');
      duration.className = 'activity__duration';
      duration.setAttribute('aria-label', `${activity.duration} minutes`);

      const durationIcon = document.createElement('span');
      durationIcon.className = 'activity__duration-icon';
      durationIcon.innerHTML =
        '<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M12 8v4l3 2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      durationIcon.setAttribute('aria-hidden', 'true');

      const durationText = document.createElement('span');
      durationText.textContent = `${activity.duration} min`;

      duration.appendChild(durationIcon);
      duration.appendChild(durationText);

      metaColumn.appendChild(duration);

      const type = document.createElement('span');
      type.className = 'activity__type';
      type.title = supportedFormats[activity.type] || activity.type;

      const typeIcon = document.createElement('span');
      typeIcon.className = 'format-icon';
      typeIcon.innerHTML = getFormatIconMarkup(activity.type);
      typeIcon.setAttribute('aria-hidden', 'true');

      const typeLabel = document.createElement('span');
      typeLabel.className = 'sr-only';
      typeLabel.textContent = supportedFormats[activity.type] || activity.type;

      type.appendChild(typeIcon);
      type.appendChild(typeLabel);

      const title = document.createElement('button');
      title.type = 'button';
      title.className = 'activity__title activity__title-button';
      title.textContent = activity.name;
      title.title = `Modifier l'activité ${activity.name}`;
      title.setAttribute('aria-label', `Modifier l'activité ${activity.name}`);
      title.addEventListener('click', (event) => {
        event.stopPropagation();
        event.preventDefault();
        openActivityEditModal(activity, weekIndex, slotIndex, activityIndex);
      });

      const titleRow = document.createElement('div');
      titleRow.className = 'activity__title-row';
      titleRow.appendChild(type);
      titleRow.appendChild(title);

      header.appendChild(metaColumn);
      header.appendChild(titleRow);

      activityEl.appendChild(header);

      const detailsText = activity.details || 'Description à compléter';
      const detailsRow = document.createElement('div');
      detailsRow.className = 'activity__details-row';

      const details = document.createElement('p');
      details.className = 'activity__details';
      details.textContent = detailsText;
      detailsRow.appendChild(details);

      if (activity.materials) {
        const materials = document.createElement('div');
        materials.className = 'activity__materials';
        materials.setAttribute('aria-label', 'Matériel');

        const materialsLabel = document.createElement('span');
        materialsLabel.className = 'sr-only';
        materialsLabel.textContent = 'Matériel :';

        const materialsIcon = document.createElement('span');
        materialsIcon.className = 'activity__materials-icon';
        materialsIcon.setAttribute('aria-hidden', 'true');
        materialsIcon.innerHTML =
          '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 3h7.5L19 7.5V21H7z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M14.5 3v5H19" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M9.5 13H15m-5.5 4H15m-5.5-8h2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';

        const materialsText = document.createElement('span');
        materialsText.className = 'activity__materials-text';
        materialsText.textContent = activity.materials;

        materials.appendChild(materialsLabel);
        materials.appendChild(materialsIcon);
        materials.appendChild(materialsText);
        detailsRow.appendChild(materials);
      }

      activityEl.appendChild(detailsRow);

      activityEl.addEventListener('dragstart', handleDragStart);
      activityEl.addEventListener('dragend', handleDragEnd);

      return activityEl;
    }

    function createSlotContent(weekIndex, slotIndex, slot) {
      const slotContent = document.createElement('div');
      slotContent.className = 'slot__content';
      slotContent.dataset.week = weekIndex;
      slotContent.dataset.slot = slotIndex;
      slotContent.dataset.holiday = slot.isHoliday ? 'true' : 'false';

      if (slot.isHoliday) {
        slotContent.classList.add('slot__content--holiday');
        const holidayLabel = document.createElement('p');
        holidayLabel.className = 'empty';
        holidayLabel.textContent = 'Congé';
        slotContent.appendChild(holidayLabel);
        return slotContent;
      }

      slotContent.addEventListener('dragover', handleDragOver);
      slotContent.addEventListener('dragenter', handleDragEnter);
      slotContent.addEventListener('dragleave', handleDragLeave);
      slotContent.addEventListener('drop', handleDrop);

      if (slot.activities.length === 0) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'Aucune activité planifiée';
        slotContent.appendChild(empty);
      } else {
        slot.activities.forEach((activity, activityIndex) => {
          slotContent.appendChild(createActivityElement(activity, weekIndex, slotIndex, activityIndex));
        });
      }

      return slotContent;
    }

    function findNextSlotIndex(weekIndex) {
      const weekSlots = schedule[weekIndex]?.slots || [];
      let lastFilledSlot = -1;

      weekSlots.forEach((slot, index) => {
        if (!slot.isHoliday && slot.activities.length > 0) {
          lastFilledSlot = index;
        }
      });

      const firstAvailableSlot = weekSlots.findIndex((slot) => !slot.isHoliday);
      if (firstAvailableSlot === -1) return null;

      const tentativeSlot = Math.min(lastFilledSlot + 1, weekSlots.length - 1);
      if (weekSlots[tentativeSlot]?.isHoliday) {
        return firstAvailableSlot;
      }

      return tentativeSlot;
    }

    async function rescheduleWeekDates(weekIndex, normalizedDate) {
      if (!currentCourseId) {
        courseStatus.textContent = 'Sélectionnez ou créez un cours avant de modifier les dates.';
        return;
      }

      if (!isValidDateInput(normalizedDate)) {
        rescheduleStatus.textContent = 'Veuillez saisir une date valide au format AAAA-MM-JJ.';
        return;
      }

      const weekNumber = weekIndex + 1;
      courseStatus.textContent = 'Recalcul des dates des semaines...';
      rescheduleStatus.textContent = '';

      try {
        const response = await authorizedFetch(
          `/api/courses/${currentCourseId}/weeks/${weekNumber}/reschedule`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ startDate: normalizedDate })
          }
        );

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Impossible de mettre à jour les dates.');
        }

        await loadActivitiesForCourse(currentCourseId);
        closeRescheduleModal();
        courseStatus.textContent = `Dates mises à jour à partir de la semaine ${weekNumber}.`;
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        rescheduleStatus.textContent = `⚠️ ${error.message}`;
      }
    }

    function openRescheduleModal(weekIndex) {
      if (!currentCourseId) {
        courseStatus.textContent = 'Sélectionnez ou créez un cours avant de modifier les dates.';
        return;
      }

      rescheduleWeekIndex = weekIndex;
      const weekNumber = weekIndex + 1;
      rescheduleWeekTitle.textContent = `Semaine ${weekNumber}`;
      rescheduleDateInput.value = getWeekStartDate(weekNumber);
      rescheduleStatus.textContent = '';

      rescheduleModal.classList.remove('is-hidden');
      rescheduleModal.hidden = false;
      rescheduleDateInput.focus();
    }

    function closeRescheduleModal() {
      rescheduleWeekIndex = null;
      rescheduleModal.classList.add('is-hidden');
      rescheduleModal.hidden = true;
    }

    function setHalfDayHolidayToggleState(isHoliday) {
      halfDayHolidayToggle.setAttribute('aria-pressed', String(isHoliday));
      halfDayHolidayToggle.classList.toggle('is-active', isHoliday);

      const stateLabel = halfDayHolidayToggle.querySelector('[data-holiday-state]');
      if (stateLabel) {
        stateLabel.textContent = isHoliday ? 'ON' : 'OFF';
      }
    }

    function getHalfDayHolidayToggleState() {
      return halfDayHolidayToggle.getAttribute('aria-pressed') === 'true';
    }

    function openHalfDayModal(weekIndex, slotIndex) {
      const slot = schedule[weekIndex]?.slots?.[slotIndex];
      if (!slot) return;

      halfDaySelection = { weekIndex, slotIndex };
      halfDayTitle.textContent = slot.label;
      setHalfDayHolidayToggleState(Boolean(slot.isHoliday));
      halfDayStatus.textContent = '';

      halfDayModal.classList.remove('is-hidden');
      halfDayModal.hidden = false;
      halfDayHolidayToggle.focus();
    }

    function closeHalfDayModal() {
      halfDaySelection = { weekIndex: null, slotIndex: null };
      halfDayModal.classList.add('is-hidden');
      halfDayModal.hidden = true;
    }

    function updateHalfDayHolidayState(isHoliday) {
      const { weekIndex, slotIndex } = halfDaySelection;
      if (weekIndex === null || slotIndex === null) return false;

      const slot = schedule[weekIndex]?.slots?.[slotIndex];
      if (!slot) return false;

      if (isHoliday && slot.activities.length > 0) {
        halfDayStatus.textContent =
          "Impossible de marquer cette demi-journée comme congé tant qu'une activité y est planifiée. Déplacez ou supprimez l'activité avant de réessayer.";
        halfDayHolidayInput.checked = false;
        return false;
      }

      const key = `${weekIndex + 1}-${slotIndex}`;

      slot.isHoliday = isHoliday;
      if (isHoliday) {
        slot.activities = [];
      }

      if (isHoliday) {
        halfDayHolidays[key] = true;
      } else {
        delete halfDayHolidays[key];
      }

      halfDayStatus.textContent = '';
      persistHolidayOverrides(currentCourseId, halfDayHolidays);
      renderSchedule();
      return true;
    }

    function renderSchedule() {
      timeline.innerHTML = '';

      schedule.forEach((week, weekIndex) => {
        const weekCard = document.createElement('article');
        weekCard.className = 'week-card';

        const header = document.createElement('div');
        header.className = 'week-card__header';

        const headerMeta = document.createElement('div');
        headerMeta.className = 'week-card__meta';

        const weekLabel = document.createElement('button');
        weekLabel.type = 'button';
        weekLabel.className = 'label week-card__title-button';
        weekLabel.textContent = `Semaine ${week.week}`;
        weekLabel.addEventListener('click', () => openRescheduleModal(weekIndex));

        headerMeta.appendChild(weekLabel);

        const addActivityBtn = document.createElement('button');
        addActivityBtn.className = 'icon-button';
        addActivityBtn.type = 'button';
        addActivityBtn.setAttribute('aria-haspopup', 'dialog');
        addActivityBtn.setAttribute('aria-label', `Ajouter une activité pour la semaine ${week.week}`);
        addActivityBtn.innerHTML = '<span aria-hidden="true">+</span>';
        addActivityBtn.addEventListener('click', () => openActivityModal(weekIndex));

        header.appendChild(headerMeta);
        header.appendChild(addActivityBtn);

        const slotsContainer = document.createElement('div');
        slotsContainer.className = 'slots';

        week.slots.forEach((slot, slotIndex) => {
          const slotWrapper = document.createElement('div');
          const hasActivities = slot.activities.length > 0;

          const slotClasses = ['slot'];
          if (hasActivities) slotClasses.push('slot--filled');
          if (slot.isHoliday) slotClasses.push('slot--holiday');

          slotWrapper.className = slotClasses.join(' ');

          const slotLabel = document.createElement('button');
          slotLabel.type = 'button';
          slotLabel.className = 'slot__label slot__label-button';
          slotLabel.textContent = slot.label;
          slotLabel.addEventListener('click', () => openHalfDayModal(weekIndex, slotIndex));

          slotWrapper.appendChild(slotLabel);
          slotWrapper.appendChild(createSlotContent(weekIndex, slotIndex, slot));
          slotsContainer.appendChild(slotWrapper);
        });

        weekCard.appendChild(header);
        weekCard.appendChild(slotsContainer);
        timeline.appendChild(weekCard);
      });
    }

    async function loadActivitiesForCourse(courseId) {
      if (!courseId || !currentUser) return;

      courseStatus.textContent = 'Chargement des activités du cours...';

      try {
        const halfDayResponse = await authorizedFetch(`/api/courses/${courseId}/half-days`);
        if (!halfDayResponse.ok) {
          throw new Error();
        }

        const { halfDays } = await halfDayResponse.json();
        courseHalfDays = halfDays || [];
        halfDayHolidays = loadHolidayOverrides(courseId);
        schedule = buildSchedule(courseHalfDays, halfDayHolidays);
        renderSchedule();

        const response = await authorizedFetch(`/api/courses/${courseId}/activities`);
        if (!response.ok) {
          throw new Error();
        }

        const activities = await response.json();

        activities.forEach((activity) => {
          const weekIndex = activity.week - 1;
          const slotIndex = activity.slot;

          const targetSlot = schedule[weekIndex]?.slots?.[slotIndex];
          if (targetSlot && !targetSlot.isHoliday) {
            targetSlot.activities.push({
              id: activity.id,
              name: activity.name,
              type: activity.type,
              details: activity.details,
              duration: activity.duration,
              materials: activity.materials
            });
          }
        });

        courseStatus.textContent = '';
        renderSchedule();
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = 'Impossible de charger les activités du cours.';
      }
    }

      async function persistActivity(payload) {
        try {
          const response = await authorizedFetch('/api/activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Sauvegarde impossible');
        }

        const body = await response.json();
        activityStatus.textContent = 'Activité enregistrée dans la base MariaDB.';
        return body.activityId;
      } catch (error) {
          if (error.message === 'UNAUTHORIZED') return null;
          activityStatus.textContent = `⚠️ ${error.message}`;
          return null;
        }
      }

      async function updateActivity(activityId, payload) {
        try {
          const response = await authorizedFetch(`/api/activities/${activityId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || "Impossible de mettre à jour l'activité.");
          }

          activityStatus.textContent = 'Activité mise à jour.';
          return true;
        } catch (error) {
          if (error.message === 'UNAUTHORIZED') return false;
          activityStatus.textContent = `⚠️ ${error.message}`;
          return false;
        }
      }

      async function deleteActivityById(activityId) {
        try {
          const response = await authorizedFetch(`/api/activities/${activityId}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || "Impossible de supprimer l'activité.");
          }

          activityStatus.textContent = 'Activité supprimée.';
          return true;
        } catch (error) {
          if (error.message === 'UNAUTHORIZED') return false;
          activityStatus.textContent = `⚠️ ${error.message}`;
          return false;
        }
      }

      async function moveActivity(activityId, weekNumber, slotIndex) {
        if (!activityId) return Promise.resolve();

        return authorizedFetch(`/api/activities/${activityId}/move`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ week: weekNumber, slot: slotIndex, courseId: currentCourseId })
        }).then(async (response) => {
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || "Impossible de mettre à jour l'activité.");
          }
        });
      }

      closeActivityModalBtn.addEventListener('click', closeActivityModal);
      activityModalBackdrop.addEventListener('click', closeActivityModal);
      openCourseModalBtn.addEventListener('click', openCourseModal);
      courseTitleButton.addEventListener('click', () => {
        if (courseTitleButton.getAttribute('aria-disabled') === 'true') return;
        openCourseEditor();
      });
      courseEditorCancelButton.addEventListener('click', closeCourseEditor);
      courseEditorDeleteButton.addEventListener('click', deleteCurrentCourse);
      closeCourseModalBtn.addEventListener('click', closeCourseModal);
      courseModalBackdrop.addEventListener('click', closeCourseModal);
      closeRescheduleModalBtn.addEventListener('click', closeRescheduleModal);
      cancelRescheduleButton.addEventListener('click', closeRescheduleModal);
      rescheduleModalBackdrop.addEventListener('click', closeRescheduleModal);
      closeHalfDayModalBtn.addEventListener('click', closeHalfDayModal);
      cancelHalfDayButton.addEventListener('click', closeHalfDayModal);
      halfDayModalBackdrop.addEventListener('click', closeHalfDayModal);
      halfDayHolidayToggle.addEventListener('click', () => {
        setHalfDayHolidayToggleState(!getHalfDayHolidayToggleState());
      });
      halfDayForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const isUpdated = updateHalfDayHolidayState(halfDayHolidayInput.checked);
        if (isUpdated) {
          closeHalfDayModal();
        }
        updateHalfDayHolidayState(getHalfDayHolidayToggleState());
        closeHalfDayModal();
      });
      rescheduleForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (rescheduleWeekIndex === null) {
          closeRescheduleModal();
          return;
        }

        await rescheduleWeekDates(rescheduleWeekIndex, rescheduleDateInput.value.trim());
      });

      tabLogin.addEventListener('click', () => showAuthOverlay('login'));
      tabRegister.addEventListener('click', () => showAuthOverlay('register', registrationDisabledMessage));

      tabRegister.setAttribute('aria-disabled', 'true');
      tabRegister.classList.add('is-disabled');

      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        authStatus.textContent = 'Connexion en cours...';

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: loginEmailInput.value.trim(),
              password: loginPasswordInput.value
            })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Impossible de se connecter.');
          }

          const user = await response.json();
          setCurrentUser(user);
          hideAuthOverlay();
          loadCourses();
        } catch (error) {
          authStatus.textContent = `⚠️ ${error.message}`;
        }
      });

      registerForm.addEventListener('submit', (event) => {
        event.preventDefault();
        showAuthOverlay('register', registrationDisabledMessage);
      });

      logoutButton.addEventListener('click', async () => {
        await fetch('/api/auth/logout', { method: 'POST' });
        setCurrentUser(null);
        halfDayHolidays = {};
        halfDaySelection = { weekIndex: null, slotIndex: null };
        schedule = createEmptySchedule();
        renderSchedule();
        showAuthOverlay('login', 'Vous êtes déconnecté.');
      });

      async function checkSession() {
        try {
          const response = await fetch('/api/auth/me');
          if (!response.ok) {
            throw new Error();
          }

          const user = await response.json();
          setCurrentUser(user);
          hideAuthOverlay();
          await loadCourses();
        } catch (error) {
          setCurrentUser(null);
          showAuthOverlay('login');
        }
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (!courseModal.hasAttribute('hidden')) {
            closeCourseModal();
          }
          if (!activityModal.hasAttribute('hidden')) {
            closeActivityModal();
          }
          if (!courseEditor.classList.contains('is-hidden')) {
            closeCourseEditor();
          }
        }
      });

      activityDeleteButton.addEventListener('click', () => {
        if (!editingActivity) return;

        const shouldDelete = window.confirm("Voulez-vous supprimer cette activité ?");
        if (!shouldDelete) return;

        activityStatus.textContent = "Suppression de l’activité en cours...";
        deleteActivityById(editingActivity.id).then((success) => {
          if (success) {
            removeActivityFromSchedule(editingActivity);
            renderSchedule();
            resetActivityFormDefaults();
            closeActivityModal();
          }
        });
      });

      activityForm.addEventListener('submit', (event) => {
        event.preventDefault();

      if (!currentCourseId) {
        activityStatus.textContent = 'Sélectionnez ou créez un cours avant d’ajouter une activité.';
        return;
      }

      const name = document.getElementById('activity-name').value.trim();
      const type = document.getElementById('type-select').value;
      const duration = Number(document.getElementById('duration').value) || 0;
      const details = document.getElementById('details').value.trim();
      const materials = document.getElementById('materials').value.trim();

      if (!name || duration <= 0) return;

      const targetWeekIndex = editingActivity ? editingActivity.weekIndex : creationWeekIndex;
      if (targetWeekIndex === null) {
        activityStatus.textContent = 'Choisissez une semaine pour ajouter une activité.';
        return;
      }

      const targetSlotIndex = editingActivity ? editingActivity.slotIndex : findNextSlotIndex(targetWeekIndex);
      if (targetSlotIndex === null || schedule[targetWeekIndex].slots[targetSlotIndex]?.isHoliday) {
        activityStatus.textContent = 'Impossible d’ajouter une activité sur une demi-journée marquée comme congé.';
        return;
      }

      const activityPayload = {
        name,
        week: targetWeekIndex + 1,
        slot: targetSlotIndex,
        format: type,
        details,
        duration,
        materials,
        courseId: currentCourseId
      };

      if (editingActivity) {
        activityStatus.textContent = "Mise à jour de l’activité en cours...";
        updateActivity(editingActivity.id, activityPayload).then((success) => {
          if (success) {
            const updatedActivity = { id: editingActivity.id, name, type, details, duration, materials };
            schedule[targetWeekIndex].slots[targetSlotIndex].activities[editingActivity.activityIndex] = updatedActivity;

            renderSchedule();
            resetActivityFormDefaults();
            closeActivityModal();
          }
        });
        return;
      }

      const targetSlot = schedule[targetWeekIndex].slots[targetSlotIndex];
      const activity = { name, type, details, duration, materials };
      activityStatus.textContent = 'Enregistrement de l’activité en cours...';
      persistActivity(activityPayload).then((activityId) => {
        if (activityId) {
          targetSlot.activities.push({ ...activity, id: activityId });
          renderSchedule();
          resetActivityFormDefaults();
          closeActivityModal();
        }
      });
    });

    courseForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      courseStatus.textContent = 'Création du cours...';

      try {
        const payload = {
          className: document.getElementById('course-class').value.trim(),
          room: document.getElementById('course-room').value.trim(),
          moduleNumber: document.getElementById('course-number').value.trim(),
          moduleName: document.getElementById('course-name').value.trim(),
          particularites: courseParticularitiesInput.value.trim(),
          startDate: courseStartDateInput.value,
          startSlot: courseStartSlotSelect.value
        };

        const response = await authorizedFetch('/api/courses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Création impossible');
        }

        const createdCourse = await response.json();
        courseForm.reset();
        courseStatus.textContent = 'Cours créé avec succès !';
        currentCourseId = createdCourse.id;
        await loadCourses();
        closeCourseModal();
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = `⚠️ ${error.message}`;
      }
    });

    courseEditorForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const moduleNumber = editCourseNumberInput.value.trim();
      const moduleName = editCourseNameInput.value.trim();
      const className = editCourseClassInput.value.trim();
      const room = editCourseRoomInput.value.trim();
      const particularites = editCourseParticularitiesInput.value.trim();

      if (!moduleNumber || !moduleName || !className || !room) {
        courseEditorStatus.textContent = 'Complétez tous les champs pour enregistrer les modifications.';
        return;
      }

      const success = await updateCourseMetadata({ moduleNumber, moduleName, className, room, particularites });

      if (success) {
        const course = getCurrentCourse();
        if (course) {
          course.moduleNumber = moduleNumber;
          course.moduleName = moduleName;
          course.className = className;
          course.room = room;
          course.particularites = particularites;
        }

        fillCourseSelect(coursesCache);
        updateCourseHeader();
        closeCourseEditor();
        courseStatus.textContent = 'Cours mis à jour.';
      }
    });

    courseSelect.addEventListener('change', async (event) => {
      if (!currentUser) {
        showAuthOverlay('login');
        return;
      }
      currentCourseId = Number(event.target.value);
      closeCourseEditor();
      updateCourseHeader();
      await loadActivitiesForCourse(currentCourseId);
    });

    renderFormatIcons();
    initializeFormatSelector();
    renderSchedule();
    checkSession();
  </script>
</body>
</html>
