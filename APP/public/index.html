<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coursio | Accueil</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="auth-overlay is-hidden" id="auth-overlay" role="dialog" aria-modal="true" aria-labelledby="auth-title" hidden>
    <div class="auth-card">
      <div class="auth-card__header">
        <p class="label" id="auth-title">Bienvenue sur Coursio</p>
        <p class="muted" id="auth-subtitle">Connectez-vous pour accéder à votre espace enseignant.</p>
      </div>
      <div class="auth-tabs">
        <button class="auth-tab is-active" id="tab-login" type="button">Connexion</button>
        <button class="auth-tab" id="tab-register" type="button" aria-disabled="true" title="La création de compte est désactivée">Créer un compte</button>
      </div>
      <form class="auth-form" id="login-form">
        <label class="form-field">
          <span>Email</span>
          <input type="email" id="login-email" autocomplete="username" required>
        </label>
        <label class="form-field">
          <span>Mot de passe</span>
          <input type="password" id="login-password" autocomplete="current-password" required>
        </label>
        <button class="btn btn-primary" type="submit">Se connecter</button>
      </form>

      <form class="auth-form is-hidden" id="register-form" aria-hidden="true">
        <label class="form-field">
          <span>Nom complet</span>
          <input type="text" id="register-name" autocomplete="name" required disabled>
        </label>
        <label class="form-field">
          <span>Email</span>
          <input type="email" id="register-email" autocomplete="email" required disabled>
        </label>
        <label class="form-field">
          <span>Mot de passe</span>
          <input type="password" id="register-password" autocomplete="new-password" minlength="8" required disabled>
        </label>
        <p class="muted">La création de compte est actuellement désactivée. Contactez votre administrateur pour obtenir un accès.</p>
        <button class="btn btn-primary" type="submit" disabled>Créer mon compte</button>
      </form>

      <p class="muted" id="auth-status" aria-live="polite"></p>
    </div>
  </div>

  <main class="sections">
    <section class="section planner" id="demo">
      <div class="planner__header">
        <div class="planner__intro">
          <div class="section__title">CoursIO - Planificateur de cours</div>
          <p class="section__subtitle"></p>
        </div>
        <div class="session-banner planner__session" id="session-banner" hidden>
          <p class="label">Connecté en tant que</p>
          <p class="muted" id="session-user"></p>
          <button class="btn btn-ghost" id="logout-button" type="button">Se déconnecter</button>
        </div>
      </div>

      <div class="course-selector" aria-label="Sélection des cours">
        <label class="form-field form-field--inline">
          <span>Cours disponibles</span>
          <select id="course-select"></select>
        </label>
        <button class="icon-button" id="open-course-modal" type="button" aria-haspopup="dialog">
          <span aria-hidden="true">+</span>
          <span class="sr-only">Créer un nouveau cours</span>
        </button>
      </div>

      <div class="course-toolbar" aria-label="Informations du cours">
        <div class="course-toolbar__intro">
          <button class="label course-title" id="course-title" type="button">Sélectionnez un module</button>
          <div class="muted course-details" id="course-details">Connectez-vous pour afficher les informations de votre cours.</div>
        </div>
      </div>

      <div class="course-editor is-hidden" id="course-editor" hidden>
        <form class="course-editor__form" id="course-editor-form">
          <div class="form-row">
            <label class="form-field">
              <span>Numéro du module</span>
              <input type="text" id="edit-course-number" required>
            </label>
            <label class="form-field">
              <span>Titre du cours</span>
              <input type="text" id="edit-course-name" required>
            </label>
          </div>
          <div class="form-row">
            <label class="form-field">
              <span>Classe</span>
              <input type="text" id="edit-course-class" required>
            </label>
            <label class="form-field">
              <span>Salle</span>
              <input type="text" id="edit-course-room" required>
            </label>
          </div>
          <label class="form-field">
            <span>Objectif général</span>
            <textarea id="edit-course-general-objective" rows="2" placeholder="Synthèse de l’intention pédagogique"></textarea>
          </label>
          <label class="form-field">
            <span>Particularités</span>
            <textarea id="edit-course-particularities" rows="2" placeholder="Précisions logistiques, modalités, etc."></textarea>
          </label>
          <div class="course-editor__actions">
            <div class="course-editor__action-buttons">
              <button class="btn btn-primary" type="submit">Mettre à jour</button>
              <button class="btn btn-danger" type="button" id="course-editor-delete">Supprimer le cours</button>
            </div>
            <button class="btn btn-ghost" type="button" id="course-editor-cancel">Fermer</button>
          </div>
          <p class="muted" id="course-editor-status"></p>
        </form>
      </div>

        <div class="planner__grid">
          <div class="timeline" aria-live="polite" aria-label="Planning des 5 semaines">
            <div class="timeline__header">
              <div>
                <p class="label">Planning</p>
              </div>
            </div>
            <div class="timeline__grid" id="timeline"></div>
          </div>
        </div>
      </section>

  </main>

  <div class="activity-modal is-hidden" id="activity-modal" role="dialog" aria-modal="true" aria-labelledby="activity-modal-title" hidden>
    <div class="activity-modal__backdrop" data-close-activity-modal></div>
    <div class="activity-modal__content">
      <div class="activity-modal__header">
        <div>
          <p class="label" id="activity-modal-title">Nouvelle activité</p>
          <p class="muted">Renseignez les détails pour l’ajouter au planning.</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-activity-modal" type="button" aria-label="Fermer le formulaire">×</button>
      </div>

      <form class="activity-form" id="activity-form">
        <label class="form-field">
          <span>Nom de l'activité</span>
          <input type="text" id="activity-name" placeholder="Ex : Atelier de prototypage" required>
        </label>

        <label class="form-field">
          <span>Format</span>
          <input type="hidden" id="type-select" value="presentation">
          <div class="format-selector" id="format-selector" role="group" aria-label="Choisir un format">
            <button class="format-chip is-selected" type="button" data-format="presentation" title="Présentation" aria-label="Présentation" aria-pressed="true">
              <span class="format-chip__icon" data-format-icon="presentation" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="exercice" title="Exercice" aria-label="Exercice" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="exercice" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="travail_de_groupe" title="Travail de groupe" aria-label="Travail de groupe" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="travail_de_groupe" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="jeu" title="Jeu" aria-label="Jeu" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="jeu" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="recherche_information" title="Recherche d'information" aria-label="Recherche d'information" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="recherche_information" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="synthese" title="Synthèse" aria-label="Synthèse" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="synthese" aria-hidden="true"></span>
            </button>
            <button class="format-chip" type="button" data-format="evaluation" title="Évaluation" aria-label="Évaluation" aria-pressed="false">
              <span class="format-chip__icon" data-format-icon="evaluation" aria-hidden="true"></span>
            </button>
          </div>
        </label>

        <label class="form-field">
          <span>Durée (minutes)</span>
          <input type="number" id="duration" min="1" max="480" value="60" required>
        </label>

        <label class="form-field">
          <span>Détails (facultatif)</span>
          <textarea id="details" rows="3" placeholder="Objectifs, matériel, format, etc."></textarea>
        </label>

        <label class="form-field">
          <span>Matériel (facultatif)</span>
          <textarea id="materials" rows="2" placeholder="Listez les ressources utiles"></textarea>
        </label>

        <div class="course-form__actions activity-form__actions">
          <div class="activity-form__buttons">
            <button class="btn btn-primary" id="activity-submit" type="submit">Ajouter l'activité</button>
            <button class="btn btn-secondary is-hidden" id="duplicate-activity" type="button">Dupliquer</button>
            <button class="btn btn-danger is-hidden" id="delete-activity" type="button">Supprimer</button>
          </div>
          <p class="muted" id="activity-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <div class="course-modal is-hidden" id="course-modal" role="dialog" aria-modal="true" aria-labelledby="course-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-course-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="course-modal-title">Nouveau cours</p>
          <p class="muted">Renseignez les informations principales pour le créer.</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-course-modal" type="button" aria-label="Fermer le formulaire">×</button>
      </div>

      <form class="course-form" id="course-form">
        <div class="form-row">
          <div class="form-field form-field--static">
            <span>Enseignant</span>
            <p id="course-teacher" class="form-static">—</p>
          </div>
          <label class="form-field">
            <span>Classe</span>
            <input type="text" id="course-class" placeholder="Ex : BTS SIO" required>
          </label>
        </div>
        <div class="form-row">
          <label class="form-field">
            <span>Salle</span>
            <input type="text" id="course-room" placeholder="Ex : Salle 204" required>
          </label>
          <label class="form-field">
            <span>Module</span>
            <input type="text" id="course-number" placeholder="Ex : MOD-101" required>
          </label>
        </div>
        <label class="form-field">
          <span>Titre du module</span>
          <input type="text" id="course-name" placeholder="Nom du module" required>
        </label>
        <label class="form-field">
          <span>Objectif général</span>
          <textarea id="course-general-objective" rows="2" placeholder="Synthèse de l’intention pédagogique"></textarea>
        </label>
        <label class="form-field">
          <span>Particularités</span>
          <textarea id="course-particularities" rows="2" placeholder="Précisions logistiques, modalités, etc."></textarea>
        </label>
        <div class="form-row">
          <label class="form-field">
            <span>Date de début</span>
            <input type="date" id="course-start-date" required>
          </label>
          <label class="form-field">
            <span>Demi-journée de début</span>
            <select id="course-start-slot">
              <option value="0">Matin</option>
              <option value="1">Après-midi</option>
            </select>
          </label>
        </div>
        <div class="course-form__actions">
          <button class="btn btn-primary" type="submit">Créer le cours</button>
          <p class="muted" id="course-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <div class="course-modal reschedule-modal is-hidden" id="reschedule-modal" role="dialog" aria-modal="true" aria-labelledby="reschedule-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-reschedule-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="reschedule-modal-title">Replanifier la semaine</p>
          <p class="muted" id="reschedule-week-title">Semaine 1</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-reschedule-modal" type="button" aria-label="Fermer le recalcul des dates">×</button>
      </div>

      <form class="course-form" id="reschedule-form">
        <label class="form-field">
          <span>Nouvelle date de début</span>
          <input type="date" id="reschedule-date" required>
        </label>
        <p class="muted">La date et les demi-journées suivantes seront recalculées pour cette semaine.</p>
        <div class="course-form__actions">
          <div class="activity-form__buttons">
            <button class="btn btn-primary" type="submit">Mettre à jour</button>
            <button class="btn btn-ghost" type="button" id="cancel-reschedule">Annuler</button>
          </div>
          <p class="muted" id="reschedule-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <div class="course-modal is-hidden" id="half-day-modal" role="dialog" aria-modal="true" aria-labelledby="half-day-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-half-day-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="half-day-modal-title">Configurer la demi-journée</p>
          <p class="muted" id="half-day-title">—</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-half-day-modal" type="button" aria-label="Fermer la configuration de la demi-journée">×</button>
      </div>

      <form class="course-form" id="half-day-form">
        <label class="form-field form-field--inline">
          <span>État de la demi-journée</span>
          <div class="half-day-toggle">
            <button class="toggle-button" type="button" id="half-day-holiday" aria-pressed="false">
              <span class="toggle-button__track" aria-hidden="true">
                <span class="toggle-button__thumb"></span>
              </span>
              <span class="toggle-button__state" data-holiday-state>OFF</span>
            </button>
            <span>Marquer cette demi-journée comme congé</span>
          </div>
        </label>

        <div class="course-form__actions">
          <button class="btn btn-primary" type="submit">Enregistrer</button>
          <button class="btn btn-ghost" type="button" id="cancel-half-day">Annuler</button>
        </div>
        <p class="muted" id="half-day-status" aria-live="polite"></p>
      </form>
    </div>
  </div>

  <div class="course-modal is-hidden" id="realtime-modal" role="dialog" aria-modal="true" aria-labelledby="realtime-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-realtime-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="realtime-modal-title">Heures réelles</p>
          <p class="muted" id="realtime-modal-subtitle">Renseignez les horaires constatés sur l'activité.</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-realtime-modal" type="button" aria-label="Fermer la saisie des heures réelles">×</button>
      </div>

      <form class="course-form" id="realtime-form">
        <div class="form-row">
          <label class="form-field">
            <span>Début réel</span>
            <input type="time" id="realtime-start" step="300">
          </label>
          <label class="form-field">
            <span>Fin réelle</span>
            <input type="time" id="realtime-end" step="300">
          </label>
        </div>
        <p class="muted" id="realtime-hint">Les horaires sont automatiquement arrondis aux 5 minutes et limités aux heures de cours.</p>
        <div class="course-form__actions">
          <div class="activity-form__buttons">
            <button class="btn btn-primary" type="submit">Enregistrer</button>
            <button class="btn btn-secondary" type="button" id="realtime-clear">Effacer</button>
            <button class="btn btn-ghost" type="button" id="realtime-cancel">Annuler</button>
          </div>
          <p class="muted" id="realtime-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>
  <script>
    const weeks = 5;
    const supportedFormats = {
      presentation: 'Présentation',
      exercice: 'Exercice',
      travail_de_groupe: 'Travail de groupe',
      jeu: 'Jeu',
      recherche_information: "Recherche d'information",
      synthese: 'Synthèse',
      evaluation: 'Évaluation'
    };

    const formatIcons = {
      presentation: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h16v8H4z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="m12 15 3.5 4m-3.5-4-3.5 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M16 10.5 8 9v3l8-1.5Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>`,
      exercice: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="6" height="6" rx="1.2" fill="none" stroke="currentColor" stroke-width="1.6"/><rect x="14" y="14" width="6" height="6" rx="1.2" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="m10 10 4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      travail_de_groupe: `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="9" cy="9" r="3" fill="none" stroke="currentColor" stroke-width="1.6"/><circle cx="15" cy="9" r="3" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M4.5 18c.6-2.1 2.6-3.5 4.8-3.5 2.2 0 4.1 1.4 4.7 3.4m2.7-3.2c1.9 0 3.4 1.3 3.8 3.3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      jeu: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="1.6"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/><circle cx="9" cy="15" r="1" fill="currentColor"/><circle cx="15" cy="15" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>`,
      recherche_information: `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="5" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="m14.5 14.5 4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      synthese: `<svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="12" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M9 9h6M9 13h6M9 17h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`,
      evaluation: `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="m9 12.5 2 2.5 4-5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`
    };

    const timerStartIconMarkup = `
      <span class="activity__timer-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.6" />
          <path d="M10 8.5 16 12l-6 3.5Z" fill="currentColor" />
        </svg>
        <span class="activity__timer-icon-label">Start</span>
      </span>
      <span class="sr-only">Démarrer</span>
    `;

    const dateFormatter = new Intl.DateTimeFormat('fr-FR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });

    const dateRangeFormatter = new Intl.DateTimeFormat('fr-FR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long'
    });

    const COURSE_PERIOD_LIMITS = {
      matin: { minMinutes: 8 * 60, maxMinutes: 11 * 60 + 45 },
      apres_midi: { minMinutes: 13 * 60, maxMinutes: 16 * 60 + 45 }
    };

    function getPeriodLimits(period) {
      if (period === 'apres_midi') return COURSE_PERIOD_LIMITS.apres_midi;
      if (period === 'matin') return COURSE_PERIOD_LIMITS.matin;

      return {
        minMinutes: COURSE_PERIOD_LIMITS.matin.minMinutes,
        maxMinutes: COURSE_PERIOD_LIMITS.apres_midi.maxMinutes
      };
    }

    function minutesToTimeString(totalMinutes) {
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    function normalizeTimeString(rawValue, period) {
      if (!rawValue) return '';

      const [hours, minutes] = rawValue.split(':').map((part) => Number(part));
      if (!Number.isInteger(hours) || !Number.isInteger(minutes)) return '';

      const roundedMinutes = Math.round((hours * 60 + minutes) / 5) * 5;
      const limits = getPeriodLimits(period);
      let clampedMinutes = Math.min(Math.max(roundedMinutes, limits.minMinutes), limits.maxMinutes);

      if (!period && clampedMinutes > COURSE_PERIOD_LIMITS.matin.maxMinutes && clampedMinutes < COURSE_PERIOD_LIMITS.apres_midi.minMinutes) {
        clampedMinutes = COURSE_PERIOD_LIMITS.apres_midi.minMinutes;
      }

      return minutesToTimeString(clampedMinutes);
    }

    function timeStringToMinutes(value) {
      if (!value) return null;
      const [hours, minutes] = value.split(':').map((part) => Number(part));
      if (!Number.isInteger(hours) || !Number.isInteger(minutes)) return null;

      return hours * 60 + minutes;
    }

    function formatHalfDayLabel(halfDay) {
      const periodLabel = halfDay.period === 'apres_midi' ? 'Après-midi' : 'Matin';
      const formattedDate = dateFormatter.format(new Date(halfDay.sessionDate));
      return `${formattedDate} • ${periodLabel}`;
    }

    function buildSchedule(halfDays = [], holidays = {}) {
      const weeksSchedule = Array.from({ length: weeks }, (_, index) => ({
        week: index + 1,
        slots: Array.from({ length: 3 }, (__, slotIndex) => ({
          label: `Créneau ${slotIndex + 1}`,
          activities: [],
          isHoliday: Boolean(holidays[`${index + 1}-${slotIndex}`]),
          sessionDate: null,
          period: null
        }))
      }));

      halfDays.forEach((halfDay) => {
        const weekIndex = halfDay.weekNumber - 1;
        const slotIndex = halfDay.slotIndex;

        if (!weeksSchedule[weekIndex] || !weeksSchedule[weekIndex].slots[slotIndex]) return;

        const key = `${halfDay.weekNumber}-${halfDay.slotIndex}`;
        const isHoliday = Boolean(holidays[key]);

        weeksSchedule[weekIndex].slots[slotIndex] = {
          label: formatHalfDayLabel(halfDay),
          activities: [],
          isHoliday,
          sessionDate: halfDay.sessionDate,
          period: halfDay.period
        };
      });

      return weeksSchedule;
    }

    function createEmptySchedule() {
      return buildSchedule();
    }

    function isValidDateInput(value) {
      if (typeof value !== 'string') return false;

      const parsed = new Date(value);
      return !Number.isNaN(parsed.getTime()) && parsed.toISOString().slice(0, 10) === value;
    }

    function getWeekStartDate(weekNumber) {
      const startingHalfDay = courseHalfDays.find(
        (halfDay) => halfDay.weekNumber === weekNumber && halfDay.slotIndex === 0
      );

      return startingHalfDay?.sessionDate || '';
    }

    function getHolidayStorageKey(courseId) {
      return `coursio-holidays-${courseId}`;
    }

    function loadHolidayOverrides(courseId) {
      if (!courseId) return {};

      try {
        const storedValue = localStorage.getItem(getHolidayStorageKey(courseId));
        return storedValue ? JSON.parse(storedValue) : {};
      } catch (error) {
        console.warn('Impossible de charger les congés locaux :', error.message);
        return {};
      }
    }

    function persistHolidayOverrides(courseId, overrides) {
      if (!courseId) return;

      try {
        localStorage.setItem(getHolidayStorageKey(courseId), JSON.stringify(overrides));
      } catch (error) {
        console.warn('Impossible de sauvegarder les congés locaux :', error.message);
      }
    }

    let schedule = buildSchedule();
    let courseHalfDays = [];
    let rescheduleWeekIndex = null;
    let halfDaySelection = { weekIndex: null, slotIndex: null };
    let halfDayHolidays = {};
    let nextTrackableActivity = null;

    const timeline = document.getElementById('timeline');
    const authOverlay = document.getElementById('auth-overlay');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const tabLogin = document.getElementById('tab-login');
    const tabRegister = document.getElementById('tab-register');
    const authStatus = document.getElementById('auth-status');
    const sessionBanner = document.getElementById('session-banner');
    const sessionUser = document.getElementById('session-user');
    const logoutButton = document.getElementById('logout-button');
    const courseTeacherDisplay = document.getElementById('course-teacher');
    const activityForm = document.getElementById('activity-form');
    const activityModal = document.getElementById('activity-modal');
    const activityModalBackdrop = document.querySelector('[data-close-activity-modal]');
    const activityStatus = document.getElementById('activity-status');
    const activityModalTitle = document.getElementById('activity-modal-title');
    const activitySubmitButton = document.getElementById('activity-submit');
    const duplicateActivityButton = document.getElementById('duplicate-activity');
    const activityDeleteButton = document.getElementById('delete-activity');
    const formatSelector = document.getElementById('format-selector');
    const formatInput = document.getElementById('type-select');
    const closeActivityModalBtn = document.getElementById('close-activity-modal');
    const courseForm = document.getElementById('course-form');
    const courseModal = document.getElementById('course-modal');
    const courseSelect = document.getElementById('course-select');
    const courseTitleButton = document.getElementById('course-title');
    const courseDetails = document.getElementById('course-details');
    const courseStatus = document.getElementById('course-status');
    const courseStartDateInput = document.getElementById('course-start-date');
    const courseStartSlotSelect = document.getElementById('course-start-slot');
    const courseGeneralObjectiveInput = document.getElementById('course-general-objective');
    const courseParticularitiesInput = document.getElementById('course-particularities');
    const courseEditor = document.getElementById('course-editor');
    const courseEditorForm = document.getElementById('course-editor-form');
    const courseEditorStatus = document.getElementById('course-editor-status');
    const courseEditorDeleteButton = document.getElementById('course-editor-delete');
    const courseEditorCancelButton = document.getElementById('course-editor-cancel');
    const editCourseNumberInput = document.getElementById('edit-course-number');
    const editCourseNameInput = document.getElementById('edit-course-name');
    const editCourseClassInput = document.getElementById('edit-course-class');
    const editCourseRoomInput = document.getElementById('edit-course-room');
    const editCourseGeneralObjectiveInput = document.getElementById('edit-course-general-objective');
    const editCourseParticularitiesInput = document.getElementById('edit-course-particularities');
    const closeCourseModalBtn = document.getElementById('close-course-modal');
    const courseModalBackdrop = document.querySelector('[data-close-course-modal]');
    const openCourseModalBtn = document.getElementById('open-course-modal');
    const rescheduleModal = document.getElementById('reschedule-modal');
    const rescheduleModalBackdrop = document.querySelector('[data-close-reschedule-modal]');
    const closeRescheduleModalBtn = document.getElementById('close-reschedule-modal');
    const rescheduleForm = document.getElementById('reschedule-form');
    const rescheduleDateInput = document.getElementById('reschedule-date');
    const rescheduleStatus = document.getElementById('reschedule-status');
    const rescheduleWeekTitle = document.getElementById('reschedule-week-title');
    const cancelRescheduleButton = document.getElementById('cancel-reschedule');
    const halfDayModal = document.getElementById('half-day-modal');
    const halfDayModalBackdrop = document.querySelector('[data-close-half-day-modal]');
    const closeHalfDayModalBtn = document.getElementById('close-half-day-modal');
    const halfDayForm = document.getElementById('half-day-form');
    const halfDayHolidayToggle = document.getElementById('half-day-holiday');
    const halfDayTitle = document.getElementById('half-day-title');
    const halfDayStatus = document.getElementById('half-day-status');
    const cancelHalfDayButton = document.getElementById('cancel-half-day');
    const loginEmailInput = document.getElementById('login-email');
    const registerNameInput = document.getElementById('register-name');
    const registerEmailInput = document.getElementById('register-email');
    const registerPasswordInput = document.getElementById('register-password');
    const loginPasswordInput = document.getElementById('login-password');
    const realtimeModal = document.getElementById('realtime-modal');
    const realtimeModalBackdrop = document.querySelector('[data-close-realtime-modal]');
    const closeRealtimeModalBtn = document.getElementById('close-realtime-modal');
    const realtimeForm = document.getElementById('realtime-form');
    const realtimeStartInput = document.getElementById('realtime-start');
    const realtimeEndInput = document.getElementById('realtime-end');
    const realtimeStatus = document.getElementById('realtime-status');
    const realtimeSubtitle = document.getElementById('realtime-modal-subtitle');
    const realtimeHint = document.getElementById('realtime-hint');
    const realtimeClearButton = document.getElementById('realtime-clear');
    const realtimeCancelButton = document.getElementById('realtime-cancel');
    const registrationDisabledMessage = 'La création de compte est désactivée. Contactez votre administrateur pour obtenir un accès.';
    let coursesCache = [];
    let draggedActivity = null;
    let dropHandled = false;
    let lastDropContainer = null;
    let currentCourseId = null;
    let editingActivity = null;
    let creationWeekIndex = null;
    let currentUser = null;
    let realTimeContext = null;

    function getActivityElements(container) {
      return Array.from(container.querySelectorAll('.activity')).filter(
        (activity) => !activity.classList.contains('is-dragging')
      );
    }

    function getInsertIndex(container, pointerY) {
      const activities = getActivityElements(container);

      for (let index = 0; index < activities.length; index += 1) {
        const rect = activities[index].getBoundingClientRect();
        const threshold = rect.top + rect.height / 2;

        if (pointerY < threshold) return index;
      }

      return activities.length;
    }

    function clearDropIndicators(container = lastDropContainer) {
      if (!container) return;

      container.classList.remove('slot__content--drop-end');
      container.querySelectorAll('.activity--drop-marker').forEach((activity) => {
        activity.classList.remove('activity--drop-marker');
      });
    }

    function updateDropIndicators(container, insertIndex) {
      if (container !== lastDropContainer) {
        clearDropIndicators();
      }

      clearDropIndicators(container);

      const activities = getActivityElements(container);

      if (insertIndex < activities.length) {
        activities[insertIndex].classList.add('activity--drop-marker');
      } else {
        container.classList.add('slot__content--drop-end');
      }

      lastDropContainer = container;
    }

    function showAuthOverlay(mode = 'login', message = '') {
      const statusMessage = message || (mode === 'register' ? registrationDisabledMessage : '');
      authStatus.textContent = statusMessage;
      authOverlay.classList.remove('is-hidden');
      authOverlay.removeAttribute('hidden');

      loginForm.classList.remove('is-hidden');
      registerForm.classList.add('is-hidden');
      tabLogin.classList.add('is-active');
      tabRegister.classList.remove('is-active');
      loginEmailInput.focus();
    }

    function hideAuthOverlay() {
      authOverlay.classList.add('is-hidden');
      authOverlay.setAttribute('hidden', '');
      authStatus.textContent = '';
    }

    function updateSessionBanner() {
      if (!currentUser) {
        sessionBanner.setAttribute('hidden', '');
        sessionUser.textContent = '';
        courseTeacherDisplay.textContent = '—';
        return;
      }

      sessionUser.textContent = `${currentUser.displayName || currentUser.name} (${currentUser.email})`;
      courseTeacherDisplay.textContent = currentUser.displayName || currentUser.name;
      sessionBanner.removeAttribute('hidden');
    }

    function setCurrentUser(user) {
      currentUser = user;
      updateSessionBanner();
      if (!user) {
        coursesCache = [];
        currentCourseId = null;
        updateCourseHeader();
        closeCourseEditor();
      }
    }

    function handleUnauthorized(message = 'Connectez-vous pour continuer.') {
      setCurrentUser(null);
      showAuthOverlay('login', message);
    }

    async function authorizedFetch(url, options = {}) {
      const response = await fetch(url, options);
      if (response.status === 401) {
        handleUnauthorized('Votre session a expiré.');
        throw new Error('UNAUTHORIZED');
      }
      return response;
    }

    function getFormatIconMarkup(format) {
      return formatIcons[format] || formatIcons.presentation;
    }

    function renderFormatIcons() {
      document.querySelectorAll('[data-format-icon]').forEach((iconEl) => {
        const format = iconEl.dataset.formatIcon;
        iconEl.innerHTML = getFormatIconMarkup(format);
      });
    }

    function formatDateRangeFromHalfDays(halfDays) {
      const validDates = (halfDays || [])
        .map((halfDay) => new Date(halfDay.sessionDate))
        .filter((date) => !Number.isNaN(date.getTime()))
        .sort((a, b) => a - b);

      if (validDates.length === 0) {
        return '';
      }

      const startDate = validDates[0];
      const endDate = validDates[validDates.length - 1];
      const startLabel = dateRangeFormatter.format(startDate);
      const endLabel = dateRangeFormatter.format(endDate);

      if (startLabel === endLabel) {
        return startLabel;
      }

      return `Du ${startLabel} au ${endLabel}`;
    }

    function buildCourseDetails(course) {
      if (!course) {
        return [];
      }

      const dateRangeLabel =
        formatDateRangeFromHalfDays(courseHalfDays) ||
        (course.startDate ? 'Date de début à préciser' : 'Dates à planifier');

      return [
        { label: 'Classe', value: course.className || 'Non précisée' },
        { label: 'Salle', value: course.room || 'Non précisée' },
        { label: 'Date', value: dateRangeLabel },
        { label: 'Objectif général', value: course.generalObjective?.trim() || 'À définir' },
        { label: 'Particularités', value: course.particularites?.trim() || 'Aucune précision' }
      ];
    }

    function renderCourseDetails(course) {
      if (!courseDetails) return;

      courseDetails.innerHTML = '';

      if (!course) {
        courseDetails.textContent = 'Choisissez ou créez un cours pour gérer vos activités.';
        return;
      }

      const detailRows = buildCourseDetails(course);

      detailRows.forEach(({ label, value }) => {
        const row = document.createElement('div');
        row.className = 'course-detail-row';

        const rowLabel = document.createElement('span');
        rowLabel.className = 'course-detail-label';
        rowLabel.textContent = label;

        const rowValue = document.createElement('span');
        rowValue.className = 'course-detail-value';
        rowValue.textContent = value;

        row.append(rowLabel, rowValue);
        courseDetails.appendChild(row);
      });
    }

    function updateCourseHeader(course = getCurrentCourse()) {
      if (!courseTitleButton || !courseDetails) return;

      if (!course) {
        courseTitleButton.textContent = 'Sélectionnez un module';
        renderCourseDetails(null);
        courseTitleButton.setAttribute('aria-disabled', 'true');
        return;
      }

      courseTitleButton.textContent = `${course.moduleNumber} · ${course.moduleName}`;
      courseTitleButton.removeAttribute('aria-disabled');
      renderCourseDetails(course);
    }

    function selectFormat(format) {
      if (!formatSelector) return;

      formatInput.value = format;
      formatSelector.querySelectorAll('.format-chip').forEach((button) => {
        const isSelected = button.dataset.format === format;
        button.classList.toggle('is-selected', isSelected);
        button.setAttribute('aria-pressed', String(isSelected));
      });
    }

    function initializeFormatSelector() {
      if (!formatSelector) return;

      formatSelector.querySelectorAll('.format-chip').forEach((button) => {
        button.addEventListener('click', () => selectFormat(button.dataset.format));
      });

      selectFormat(formatInput.value || Object.keys(supportedFormats)[0]);
    }

    function setActivityFormMode(mode) {
      if (mode === 'edit') {
        activitySubmitButton.textContent = "Modifier l'activité";
        activityModalTitle.textContent = 'Modifier une activité';
        duplicateActivityButton.classList.remove('is-hidden');
        activityDeleteButton.classList.remove('is-hidden');
        return;
      }

      editingActivity = null;
      activitySubmitButton.textContent = "Ajouter l'activité";
      activityModalTitle.textContent = 'Nouvelle activité';
      duplicateActivityButton.classList.add('is-hidden');
      activityDeleteButton.classList.add('is-hidden');
    }

    function resetActivityFormDefaults() {
      activityForm.reset();
      document.getElementById('duration').value = 60;
      selectFormat('presentation');
    }

    function openActivityModal(weekIndex) {
      const availableSlotIndex = findNextSlotIndex(weekIndex);
      if (availableSlotIndex === null) {
        activityStatus.textContent = 'Cette semaine est configurée en congé. Retirez le congé pour ajouter une activité.';
        return;
      }

      creationWeekIndex = weekIndex;
      setActivityFormMode('create');
      resetActivityFormDefaults();
      activityStatus.textContent = '';
      activityModal.removeAttribute('hidden');
      activityModal.classList.remove('is-hidden');
      document.getElementById('activity-name').focus();
    }

    function closeActivityModal() {
      creationWeekIndex = null;
      activityModal.setAttribute('hidden', '');
      activityModal.classList.add('is-hidden');
      setActivityFormMode('create');
    }

    function openActivityEditModal(activity, weekIndex, slotIndex, activityIndex) {
      if (!activity) return;

      creationWeekIndex = weekIndex;
      editingActivity = { id: activity.id, weekIndex, slotIndex, activityIndex };
      setActivityFormMode('edit');

      document.getElementById('activity-name').value = activity.name;
      document.getElementById('duration').value = activity.duration;
      document.getElementById('details').value = activity.details || '';
      document.getElementById('materials').value = activity.materials || '';

      selectFormat(activity.type);

      activityStatus.textContent = '';
      activityModal.removeAttribute('hidden');
      activityModal.classList.remove('is-hidden');
      document.getElementById('activity-name').focus();
    }

    function openCourseModal() {
      if (!currentUser) {
        showAuthOverlay('login', 'Connectez-vous pour créer un cours.');
        return;
      }

      courseForm.reset();
      courseStatus.textContent = '';
      courseModal.removeAttribute('hidden');
      courseModal.classList.remove('is-hidden');
      courseStartDateInput.value = new Date().toISOString().slice(0, 10);
      courseStartSlotSelect.value = 0;
      courseTeacherDisplay.textContent = currentUser?.displayName || currentUser?.name || '—';
      document.getElementById('course-class').focus();
    }

    function closeCourseModal() {
      courseModal.setAttribute('hidden', '');
      courseModal.classList.add('is-hidden');
    }

    function closeCourseEditor() {
      if (!courseEditor) return;
      courseEditor.classList.add('is-hidden');
      courseEditor.hidden = true;
      courseEditorStatus.textContent = '';
    }

    function openCourseEditor() {
      if (!currentUser) {
        showAuthOverlay('login', 'Connectez-vous pour modifier un cours.');
        return;
      }

      const course = getCurrentCourse();

      if (!course) {
        courseStatus.textContent = 'Sélectionnez un cours à modifier.';
        return;
      }

      courseEditorStatus.textContent = '';
      editCourseNumberInput.value = course.moduleNumber || '';
      editCourseNameInput.value = course.moduleName || '';
      editCourseClassInput.value = course.className || '';
      editCourseRoomInput.value = course.room || '';
      editCourseGeneralObjectiveInput.value = course.generalObjective || '';
      editCourseParticularitiesInput.value = course.particularites || '';

      courseEditor.classList.remove('is-hidden');
      courseEditor.hidden = false;
      editCourseNumberInput.focus();
    }

    function fillCourseSelect(courses) {
      coursesCache = courses;
      courseSelect.innerHTML = '';

      courses.forEach((course) => {
        const option = document.createElement('option');
        option.value = course.id;
        option.textContent = `${course.moduleNumber} — ${course.moduleName}`;
        option.dataset.moduleNumber = course.moduleNumber;
        courseSelect.appendChild(option);
      });

      const hasCurrentSelection = courses.some((course) => course.id === currentCourseId);

      if (!hasCurrentSelection) {
        currentCourseId = courses[0]?.id ?? null;
      }

      if (currentCourseId) {
        courseSelect.value = currentCourseId;
      }

      updateCourseHeader();
    }

    async function loadCourses() {
      if (!currentUser) {
        courseStatus.textContent = 'Connectez-vous pour afficher vos cours.';
        updateCourseHeader(null);
        return;
      }

      courseStatus.textContent = 'Chargement des cours...';

      try {
        const response = await authorizedFetch('/api/courses');
        if (!response.ok) {
          throw new Error();
        }

        const courses = await response.json();
        fillCourseSelect(courses);

        if (courses.length === 0) {
          courseStatus.textContent = 'Aucun cours disponible pour le moment.';
          currentCourseId = null;
          halfDayHolidays = {};
          halfDaySelection = { weekIndex: null, slotIndex: null };
          schedule = createEmptySchedule();
          renderSchedule();
          updateCourseHeader(null);
          return;
        }

        courseStatus.textContent = '';
        currentCourseId = Number(courseSelect.value);
        await loadActivitiesForCourse(currentCourseId);
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = 'Impossible de charger les cours.';
      }
    }

    function getCurrentCourse() {
      return coursesCache.find((course) => course.id === currentCourseId) || null;
    }

    async function deleteCurrentCourse() {
      if (!currentCourseId) {
        courseStatus.textContent = 'Sélectionnez d’abord un cours à supprimer.';
        return;
      }

      const course = getCurrentCourse();
      if (!course) {
        courseStatus.textContent = 'Cours introuvable dans la sélection.';
        return;
      }

      const confirmationMessage =
        `Pour supprimer le cours ${course.moduleNumber} (${course.moduleName}), saisissez son numéro de module. ` +
        'Cette action supprimera aussi tous les demi-jours et activités associés.';

      const userInput = window.prompt(confirmationMessage);

      if (userInput === null) {
        courseStatus.textContent = 'Suppression annulée.';
        return;
      }

      const moduleNumberInput = userInput.trim();

      if (moduleNumberInput !== course.moduleNumber) {
        courseStatus.textContent = 'Le numéro saisi ne correspond pas au cours sélectionné.';
        return;
      }

      courseStatus.textContent = 'Suppression du cours en cours...';

      try {
        const response = await authorizedFetch(`/api/courses/${course.id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ moduleNumber: moduleNumberInput })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Impossible de supprimer le cours.');
        }

        currentCourseId = null;
        courseStatus.textContent = 'Cours supprimé.';
        closeCourseEditor();
        await loadCourses();
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = `⚠️ ${error.message}`;
      }
    }

    async function updateCourseMetadata(payload) {
      if (!currentCourseId) {
        courseEditorStatus.textContent = 'Sélectionnez un cours avant de le modifier.';
        return false;
      }

      courseEditorStatus.textContent = 'Mise à jour du cours en cours...';

      try {
        const response = await authorizedFetch(`/api/courses/${currentCourseId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Impossible de mettre à jour le cours.');
        }

        courseEditorStatus.textContent = 'Cours mis à jour.';
        return true;
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return false;
        courseEditorStatus.textContent = `⚠️ ${error.message}`;
        return false;
      }
    }

    function handleDragStart(event) {
      const { week, slot, index, id } = event.currentTarget.dataset;
      draggedActivity = {
        week: Number(week),
        slot: Number(slot),
        index: Number(index),
        id: Number(id)
      };
      dropHandled = false;
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', '');
      event.currentTarget.classList.add('is-dragging');
    }

    function handleDragEnd(event) {
      event.currentTarget.classList.remove('is-dragging');

      draggedActivity = null;
      dropHandled = false;
      clearDropIndicators();
      lastDropContainer = null;
    }

    function isHolidayTarget(event) {
      return event?.currentTarget?.dataset?.holiday === 'true';
    }

    function handleDragOver(event) {
      if (isHolidayTarget(event)) return;
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';

      const insertIndex = getInsertIndex(event.currentTarget, event.clientY);
      updateDropIndicators(event.currentTarget, insertIndex);
    }

    function handleDragEnter(event) {
      if (isHolidayTarget(event)) return;
      event.currentTarget.classList.add('slot__content--over');
    }

    function handleDragLeave(event) {
      if (isHolidayTarget(event)) return;
      event.currentTarget.classList.remove('slot__content--over');

      if (!event.currentTarget.contains(event.relatedTarget)) {
        clearDropIndicators(event.currentTarget);
      }
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('slot__content--over');
      clearDropIndicators(event.currentTarget);

      if (!draggedActivity) return;

      dropHandled = true;

      const targetWeek = Number(event.currentTarget.dataset.week);
      const targetSlot = Number(event.currentTarget.dataset.slot);
      const insertIndex = getInsertIndex(event.currentTarget, event.clientY);

      const targetSlotData = schedule[targetWeek]?.slots?.[targetSlot];
      if (!targetSlotData || targetSlotData.isHoliday) return;

      const sourceSlot = schedule[draggedActivity.week].slots[draggedActivity.slot];
      const [activity] = sourceSlot.activities.splice(draggedActivity.index, 1);

      const boundedIndex = Math.min(Math.max(insertIndex, 0), targetSlotData.activities.length);
      targetSlotData.activities.splice(boundedIndex, 0, activity);

      moveActivity(draggedActivity.id, targetWeek + 1, targetSlot, boundedIndex).catch(() => {
        courseStatus.textContent = '⚠️ Impossible de mettre à jour la base, rechargement du planning...';
        loadActivitiesForCourse(currentCourseId);
      });

      draggedActivity = null;
      renderSchedule();
    }

    function removeActivityFromSchedule(context) {
      const slot = schedule[context.weekIndex]?.slots?.[context.slotIndex];
      if (!slot) return null;

      return slot.activities.splice(context.activityIndex, 1)[0] || null;
    }

    function addActivityToSchedule(activity, weekIndex, slotIndex) {
      const slot = schedule[weekIndex]?.slots?.[slotIndex];
      if (!slot) return;

      slot.activities.push(activity);
    }

    function formatTimeLabel(isoString) {
      if (!isoString) return '--:--';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '--:--';

      return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function getRealTimeLabel(activity) {
      const startLabel = formatTimeLabel(activity.actualStart);
      const endLabel = formatTimeLabel(activity.actualEnd);

      if (!activity.actualStart && !activity.actualEnd) {
        return '';
      }

      if (activity.actualStart && !activity.actualEnd) {
        return `${startLabel} - en cours`;
      }

      return `${startLabel} - ${endLabel}`;
    }

    function openManualTimePrompt(activity) {
      const currentValue = `${formatTimeLabel(activity.actualStart)}${
        activity.actualEnd ? ` - ${formatTimeLabel(activity.actualEnd)}` : ''
      }`.replace(/^--:--\s?-?\s?/, '');
      const userInput = window.prompt('Heures réelles (HH:MM-HH:MM). Laissez vide pour effacer.', currentValue.trim());
      if (userInput === null) return;

      try {
        const parsed = parseManualTimeInput(userInput, activity);
        const payload = {};
        if (parsed.actualStart !== undefined) payload.actualStart = parsed.actualStart;
        if (parsed.actualEnd !== undefined) payload.actualEnd = parsed.actualEnd;

        updateActivityTiming(activity.id, payload).then((result) => {
          if (!result) return;
          activity.actualStart = result.actualStart;
          activity.actualEnd = result.actualEnd;
          renderSchedule();
        });
      } catch (error) {
        activityStatus.textContent = `⚠️ ${error.message}`;
      }
    }

    function buildIsoFromTime(activity, timeString) {
      const normalizedTime = normalizeTimeString(timeString, activity?.period);
      if (!normalizedTime) return null;

      const [hours, minutes] = normalizedTime.split(':').map((part) => Number(part));
      const referenceDate = activity.sessionDate || new Date().toISOString().slice(0, 10);
      const isoString = `${referenceDate}T${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;
      const parsed = new Date(isoString);

      if (Number.isNaN(parsed.getTime())) return null;
      return parsed.toISOString();
    }

    function parseManualTimeInput(rawInput, activity) {
      const value = (rawInput || '').trim();
      if (!value) {
        return { actualStart: null, actualEnd: null };
      }

      const [startRaw, endRaw] = value.split('-').map((part) => part.trim());

      const startIso = startRaw ? buildIsoFromTime(activity, startRaw) : undefined;
      const endIso = endRaw ? buildIsoFromTime(activity, endRaw) : undefined;

      if (startRaw && !startIso) {
        throw new Error('Format de début invalide. Utilisez HH:MM.');
      }

      if (endRaw && !endIso) {
        throw new Error('Format de fin invalide. Utilisez HH:MM.');
      }

      if (startIso && endIso) {
        const startDate = new Date(startIso);
        const endDate = new Date(endIso);

        if (endDate < startDate) {
          throw new Error("L'heure de fin doit être après l'heure de début.");
        }
      }

      return { actualStart: startIso ?? undefined, actualEnd: endIso ?? undefined };
    }

    function isoToTimeValue(isoString, period) {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '';

      return normalizeTimeString(
        `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`,
        period
      );
    }

    function getPeriodRangeText(period) {
      if (period === 'matin') return '08h00 - 11h45';
      if (period === 'apres_midi') return '13h00 - 16h45';
      return '08h00 - 11h45 et 13h00 - 16h45';
    }

    function getRealTimeContext(activity, slot) {
      return {
        activity,
        period: activity.period || slot?.period || null,
        sessionDate: activity.sessionDate || slot?.sessionDate || activity.sessionDate || null
      };
    }

    function setRealtimeInputsFromActivity(context) {
      const { activity, period } = context;
      realtimeStartInput.value = isoToTimeValue(activity.actualStart, period);
      realtimeEndInput.value = isoToTimeValue(activity.actualEnd, period);
    }

    function applyRealtimeConstraints(period) {
      const limits = getPeriodLimits(period);
      const minValue = minutesToTimeString(limits.minMinutes);
      const maxValue = minutesToTimeString(limits.maxMinutes);

      realtimeStartInput.min = minValue;
      realtimeEndInput.min = minValue;
      realtimeStartInput.max = maxValue;
      realtimeEndInput.max = maxValue;
      realtimeHint.textContent = `Les horaires sont automatiquement arrondis aux 5 minutes et limités à ${getPeriodRangeText(period)}.`;
    }

    function openRealtimeModal(activity, slot) {
      realTimeContext = getRealTimeContext(activity, slot);
      realtimeStatus.textContent = '';
      realtimeSubtitle.textContent = slot?.label || "Renseignez les horaires constatés sur l'activité.";

      applyRealtimeConstraints(realTimeContext.period);
      setRealtimeInputsFromActivity(realTimeContext);

      realtimeModal.classList.remove('is-hidden');
      realtimeModal.hidden = false;
      realtimeStartInput.focus();
    }

    function closeRealtimeModal() {
      realTimeContext = null;
      realtimeStatus.textContent = '';
      realtimeStartInput.value = '';
      realtimeEndInput.value = '';
      realtimeModal.classList.add('is-hidden');
      realtimeModal.hidden = true;
    }

    function buildRealtimePayload(startValue, endValue) {
      if (!realTimeContext) return null;

      const activityContext = {
        ...realTimeContext.activity,
        period: realTimeContext.period,
        sessionDate: realTimeContext.sessionDate || realTimeContext.activity.sessionDate
      };

      return {
        actualStart: startValue ? buildIsoFromTime(activityContext, startValue) : null,
        actualEnd: endValue ? buildIsoFromTime(activityContext, endValue) : null
      };
    }

    async function persistRealtimeTiming(payload) {
      if (!realTimeContext) return;
      realtimeStatus.textContent = 'Enregistrement...';

      const result = await updateActivityTiming(realTimeContext.activity.id, payload);

      if (!result) {
        realtimeStatus.textContent = activityStatus.textContent || 'Impossible de mettre à jour les heures réelles.';
        return;
      }

      realTimeContext.activity.actualStart = result.actualStart;
      realTimeContext.activity.actualEnd = result.actualEnd;
      realtimeStatus.textContent = '';
      closeRealtimeModal();
      renderSchedule();
    }

    async function handleRealtimeSubmit(event) {
      event.preventDefault();
      if (!realTimeContext) return;

      const period = realTimeContext.period;
      const normalizedStart = normalizeTimeString(realtimeStartInput.value, period);
      const normalizedEnd = normalizeTimeString(realtimeEndInput.value, period);

      realtimeStartInput.value = normalizedStart;
      realtimeEndInput.value = normalizedEnd;

      if (!normalizedStart && !normalizedEnd) {
        realtimeStatus.textContent = 'Saisissez au moins un horaire ou utilisez le bouton Effacer pour vider les champs.';
        return;
      }

      if (normalizedStart && normalizedEnd) {
        const startMinutes = timeStringToMinutes(normalizedStart);
        const endMinutes = timeStringToMinutes(normalizedEnd);

        if (endMinutes !== null && startMinutes !== null && endMinutes < startMinutes) {
          realtimeStatus.textContent = "L'heure de fin doit être après l'heure de début.";
          return;
        }
      }

      const payload = buildRealtimePayload(normalizedStart, normalizedEnd);
      if (!payload) return;

      await persistRealtimeTiming(payload);
    }

    async function handleRealtimeClear() {
      if (!realTimeContext) return;
      realtimeStartInput.value = '';
      realtimeEndInput.value = '';

      await persistRealtimeTiming({ actualStart: null, actualEnd: null });
    }

    function findNextTrackableActivity() {
      const weeks = schedule || [];
      for (let weekIndex = 0; weekIndex < weeks.length; weekIndex += 1) {
        const slots = weeks[weekIndex]?.slots || [];
        for (let slotIndex = 0; slotIndex < slots.length; slotIndex += 1) {
          const slot = slots[slotIndex];
          if (!slot || slot.isHoliday) continue;

          for (let activityIndex = 0; activityIndex < slot.activities.length; activityIndex += 1) {
            const activity = slot.activities[activityIndex];
            if (!activity) continue;

            if (!activity.actualEnd) {
              return { weekIndex, slotIndex, activityIndex };
            }
          }
        }
      }

      return null;
    }

    function isTrackableActivity(weekIndex, slotIndex, activityIndex) {
      if (!nextTrackableActivity) return false;
      return (
        weekIndex === nextTrackableActivity.weekIndex &&
        slotIndex === nextTrackableActivity.slotIndex &&
        activityIndex === nextTrackableActivity.activityIndex
      );
    }

    function createActivityElement(activity, weekIndex, slotIndex, activityIndex) {
      const activityEl = document.createElement('div');
      activityEl.className = 'activity';
      activityEl.draggable = true;
      activityEl.dataset.week = weekIndex;
      activityEl.dataset.slot = slotIndex;
      activityEl.dataset.index = activityIndex;
      activityEl.dataset.id = activity.id;

      const header = document.createElement('div');
      header.className = 'activity__header';

      const metaColumn = document.createElement('div');
      metaColumn.className = 'activity__meta';

      const duration = document.createElement('div');
      duration.className = 'activity__duration';
      duration.setAttribute('aria-label', `${activity.duration} minutes`);

      const durationIcon = document.createElement('span');
      durationIcon.className = 'activity__duration-icon';
      durationIcon.innerHTML =
        '<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M12 8v4l3 2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      durationIcon.setAttribute('aria-hidden', 'true');

      const durationText = document.createElement('span');
      durationText.textContent = `${activity.duration} min`;

      duration.appendChild(durationIcon);
      duration.appendChild(durationText);

      metaColumn.appendChild(duration);

      const realTimeButton = document.createElement('button');
      realTimeButton.type = 'button';
      realTimeButton.className = 'activity__realtime';
      const realTimeLabel = getRealTimeLabel(activity);
      realTimeButton.textContent = realTimeLabel;
      realTimeButton.classList.toggle('activity__realtime--empty', realTimeLabel === '');
      realTimeButton.setAttribute('aria-label', realTimeLabel || 'Ajouter des heures réelles');
      realTimeButton.title = 'Modifier les heures réelles';
      realTimeButton.addEventListener('click', (event) => {
        event.stopPropagation();
        const slot = schedule[weekIndex]?.slots?.[slotIndex];
        openRealtimeModal(activity, slot);
      });

      metaColumn.appendChild(realTimeButton);

      if (isTrackableActivity(weekIndex, slotIndex, activityIndex)) {
        const timerButton = document.createElement('button');
        const isRunning = Boolean(activity.actualStart && !activity.actualEnd);
        timerButton.type = 'button';
        timerButton.className = 'activity__timer-button btn btn-primary';
        if (isRunning) {
          timerButton.textContent = 'Arrêter';
          timerButton.setAttribute('aria-label', 'Arrêter le chronomètre');
        } else {
          timerButton.innerHTML = timerStartIconMarkup;
          timerButton.setAttribute('aria-label', 'Démarrer le chronomètre');
        }
        timerButton.addEventListener('click', (event) => {
          event.stopPropagation();
          const nowIso = new Date().toISOString();
          const payload = isRunning ? { actualEnd: nowIso } : { actualStart: nowIso, actualEnd: null };
          updateActivityTiming(activity.id, payload).then((result) => {
            if (!result) return;
            activity.actualStart = result.actualStart;
            activity.actualEnd = result.actualEnd;
            renderSchedule();
          });
        });

        metaColumn.appendChild(timerButton);
      }

      const type = document.createElement('span');
      type.className = 'activity__type';
      type.title = supportedFormats[activity.type] || activity.type;

      const typeIcon = document.createElement('span');
      typeIcon.className = 'format-icon';
      typeIcon.innerHTML = getFormatIconMarkup(activity.type);
      typeIcon.setAttribute('aria-hidden', 'true');

      const typeLabel = document.createElement('span');
      typeLabel.className = 'sr-only';
      typeLabel.textContent = supportedFormats[activity.type] || activity.type;

      type.appendChild(typeIcon);
      type.appendChild(typeLabel);

      const title = document.createElement('button');
      title.type = 'button';
      title.className = 'activity__title activity__title-button';
      title.textContent = activity.name;
      title.title = `Modifier l'activité ${activity.name}`;
      title.setAttribute('aria-label', `Modifier l'activité ${activity.name}`);
      title.addEventListener('click', (event) => {
        event.stopPropagation();
        event.preventDefault();
        openActivityEditModal(activity, weekIndex, slotIndex, activityIndex);
      });

      const titleRow = document.createElement('div');
      titleRow.className = 'activity__title-row';
      titleRow.appendChild(type);
      titleRow.appendChild(title);

      header.appendChild(metaColumn);
      header.appendChild(titleRow);

      activityEl.appendChild(header);

      const detailsText = activity.details || 'Description à compléter';
      const detailsRow = document.createElement('div');
      detailsRow.className = 'activity__details-row';

      const details = document.createElement('p');
      details.className = 'activity__details';
      details.textContent = detailsText;
      detailsRow.appendChild(details);

      const materialItems = activity.materials
        ? activity.materials
            .split('\n')
            .map((item) => item.trim())
            .filter(Boolean)
        : [];

      const materials = document.createElement('div');
      materials.className = 'activity__materials';
      materials.setAttribute('aria-label', 'Matériel');

      const materialsLabel = document.createElement('span');
      materialsLabel.className = 'sr-only';
      materialsLabel.textContent = 'Matériel :';

      const materialsList = document.createElement('div');
      materialsList.className = 'activity__materials-list';

      if (materialItems.length > 0) {
        materialItems.forEach((item) => {
          const materialRow = document.createElement('div');
          materialRow.className = 'activity__materials-item';

          const materialsIcon = document.createElement('span');
          materialsIcon.className = 'activity__materials-icon';
          materialsIcon.setAttribute('aria-hidden', 'true');
          materialsIcon.innerHTML =
            '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 3h7.5L19 7.5V21H7z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M14.5 3v5H19" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M9.5 13H15m-5.5 4H15m-5.5-8h2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';

          const materialsText = document.createElement('span');
          materialsText.className = 'activity__materials-text';
          materialsText.textContent = item;

          materialRow.appendChild(materialsIcon);
          materialRow.appendChild(materialsText);
          materialsList.appendChild(materialRow);
        });
      } else {
        const emptyMaterials = document.createElement('span');
        emptyMaterials.className = 'empty';
        emptyMaterials.textContent = 'Aucune ressource';
        materialsList.appendChild(emptyMaterials);
      }

      materials.appendChild(materialsLabel);
      materials.appendChild(materialsList);
      detailsRow.appendChild(materials);

      activityEl.appendChild(detailsRow);

      activityEl.addEventListener('dragstart', handleDragStart);
      activityEl.addEventListener('dragend', handleDragEnd);

      return activityEl;
    }

    function createSlotContent(weekIndex, slotIndex, slot) {
      const slotContent = document.createElement('div');
      slotContent.className = 'slot__content';
      slotContent.dataset.week = weekIndex;
      slotContent.dataset.slot = slotIndex;
      slotContent.dataset.holiday = slot.isHoliday ? 'true' : 'false';

      if (slot.isHoliday) {
        slotContent.classList.add('slot__content--holiday');
        const holidayLabel = document.createElement('p');
        holidayLabel.className = 'empty';
        holidayLabel.textContent = 'Congé';
        slotContent.appendChild(holidayLabel);
        return slotContent;
      }

      slotContent.addEventListener('dragover', handleDragOver);
      slotContent.addEventListener('dragenter', handleDragEnter);
      slotContent.addEventListener('dragleave', handleDragLeave);
      slotContent.addEventListener('drop', handleDrop);

      if (slot.activities.length === 0) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'Aucune activité planifiée';
        slotContent.appendChild(empty);
      } else {
        slot.activities.forEach((activity, activityIndex) => {
          slotContent.appendChild(createActivityElement(activity, weekIndex, slotIndex, activityIndex));
        });
      }

      return slotContent;
    }

    function findNextSlotIndex(weekIndex) {
      const weekSlots = schedule[weekIndex]?.slots || [];
      let lastFilledSlot = -1;

      weekSlots.forEach((slot, index) => {
        if (!slot.isHoliday && slot.activities.length > 0) {
          lastFilledSlot = index;
        }
      });

      const firstAvailableSlot = weekSlots.findIndex((slot) => !slot.isHoliday);
      if (firstAvailableSlot === -1) return null;

      const tentativeSlot = Math.min(lastFilledSlot + 1, weekSlots.length - 1);
      if (weekSlots[tentativeSlot]?.isHoliday) {
        return firstAvailableSlot;
      }

      return tentativeSlot;
    }

    function findNextHalfDaySlot(currentWeekIndex, currentSlotIndex) {
      const totalWeeks = schedule?.length || 0;
      const slotsPerWeek = schedule?.[0]?.slots?.length || 0;

      if (totalWeeks === 0 || slotsPerWeek === 0) return null;

      const startLinearIndex = currentWeekIndex * slotsPerWeek + currentSlotIndex + 1;
      const totalSlots = totalWeeks * slotsPerWeek;

      for (let linearIndex = startLinearIndex; linearIndex < totalSlots; linearIndex += 1) {
        const targetWeekIndex = Math.floor(linearIndex / slotsPerWeek);
        const targetSlotIndex = linearIndex % slotsPerWeek;

        const targetSlot = schedule[targetWeekIndex]?.slots?.[targetSlotIndex];
        if (targetSlot && !targetSlot.isHoliday) {
          return { weekIndex: targetWeekIndex, slotIndex: targetSlotIndex };
        }
      }

      return null;
    }

    async function rescheduleWeekDates(weekIndex, normalizedDate) {
      if (!currentCourseId) {
        courseStatus.textContent = 'Sélectionnez ou créez un cours avant de modifier les dates.';
        return;
      }

      if (!isValidDateInput(normalizedDate)) {
        rescheduleStatus.textContent = 'Veuillez saisir une date valide au format AAAA-MM-JJ.';
        return;
      }

      const weekNumber = weekIndex + 1;
      courseStatus.textContent = 'Recalcul des dates des semaines...';
      rescheduleStatus.textContent = '';

      try {
        const response = await authorizedFetch(
          `/api/courses/${currentCourseId}/weeks/${weekNumber}/reschedule`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ startDate: normalizedDate })
          }
        );

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Impossible de mettre à jour les dates.');
        }

        await loadActivitiesForCourse(currentCourseId);
        closeRescheduleModal();
        courseStatus.textContent = `Dates mises à jour à partir de la semaine ${weekNumber}.`;
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        rescheduleStatus.textContent = `⚠️ ${error.message}`;
      }
    }

    function openRescheduleModal(weekIndex) {
      if (!currentCourseId) {
        courseStatus.textContent = 'Sélectionnez ou créez un cours avant de modifier les dates.';
        return;
      }

      rescheduleWeekIndex = weekIndex;
      const weekNumber = weekIndex + 1;
      rescheduleWeekTitle.textContent = `Semaine ${weekNumber}`;
      rescheduleDateInput.value = getWeekStartDate(weekNumber);
      rescheduleStatus.textContent = '';

      rescheduleModal.classList.remove('is-hidden');
      rescheduleModal.hidden = false;
      rescheduleDateInput.focus();
    }

    function closeRescheduleModal() {
      rescheduleWeekIndex = null;
      rescheduleModal.classList.add('is-hidden');
      rescheduleModal.hidden = true;
    }

    function setHalfDayHolidayToggleState(isHoliday) {
      halfDayHolidayToggle.setAttribute('aria-pressed', String(isHoliday));
      halfDayHolidayToggle.classList.toggle('is-active', isHoliday);

      const stateLabel = halfDayHolidayToggle.querySelector('[data-holiday-state]');
      if (stateLabel) {
        stateLabel.textContent = isHoliday ? 'ON' : 'OFF';
      }
    }

    function getHalfDayHolidayToggleState() {
      return halfDayHolidayToggle.getAttribute('aria-pressed') === 'true';
    }

    function openHalfDayModal(weekIndex, slotIndex) {
      const slot = schedule[weekIndex]?.slots?.[slotIndex];
      if (!slot) return;

      halfDaySelection = { weekIndex, slotIndex };
      halfDayTitle.textContent = slot.label;
      setHalfDayHolidayToggleState(Boolean(slot.isHoliday));
      halfDayStatus.textContent = '';

      halfDayModal.classList.remove('is-hidden');
      halfDayModal.hidden = false;
      halfDayHolidayToggle.focus();
    }

    function closeHalfDayModal() {
      halfDaySelection = { weekIndex: null, slotIndex: null };
      halfDayModal.classList.add('is-hidden');
      halfDayModal.hidden = true;
    }

    function updateHalfDayHolidayState(isHoliday) {
      const { weekIndex, slotIndex } = halfDaySelection;
      if (weekIndex === null || slotIndex === null) return false;

      const slot = schedule[weekIndex]?.slots?.[slotIndex];
      if (!slot) return false;

      if (isHoliday && slot.activities.length > 0) {
        halfDayStatus.textContent =
          "Impossible de marquer cette demi-journée comme congé tant qu'une activité y est planifiée. Déplacez ou supprimez l'activité avant de réessayer.";
        setHalfDayHolidayToggleState(false);
        return false;
      }

      const key = `${weekIndex + 1}-${slotIndex}`;

      slot.isHoliday = isHoliday;
      if (isHoliday) {
        slot.activities = [];
      }

      if (isHoliday) {
        halfDayHolidays[key] = true;
      } else {
        delete halfDayHolidays[key];
      }

      halfDayStatus.textContent = '';
      persistHolidayOverrides(currentCourseId, halfDayHolidays);
      renderSchedule();
      return true;
    }

    function renderSchedule() {
      nextTrackableActivity = findNextTrackableActivity();
      timeline.innerHTML = '';

      schedule.forEach((week, weekIndex) => {
        const weekCard = document.createElement('article');
        weekCard.className = 'week-card';

        const header = document.createElement('div');
        header.className = 'week-card__header';

        const headerMeta = document.createElement('div');
        headerMeta.className = 'week-card__meta';

        const weekLabel = document.createElement('button');
        weekLabel.type = 'button';
        weekLabel.className = 'label week-card__title-button';
        weekLabel.textContent = `Semaine ${week.week}`;
        weekLabel.addEventListener('click', () => openRescheduleModal(weekIndex));

        headerMeta.appendChild(weekLabel);

        const addActivityBtn = document.createElement('button');
        addActivityBtn.className = 'icon-button';
        addActivityBtn.type = 'button';
        addActivityBtn.setAttribute('aria-haspopup', 'dialog');
        addActivityBtn.setAttribute('aria-label', `Ajouter une activité pour la semaine ${week.week}`);
        addActivityBtn.innerHTML = '<span aria-hidden="true">+</span>';
        addActivityBtn.addEventListener('click', () => openActivityModal(weekIndex));

        header.appendChild(headerMeta);
        header.appendChild(addActivityBtn);

        const slotsContainer = document.createElement('div');
        slotsContainer.className = 'slots';

        week.slots.forEach((slot, slotIndex) => {
          const slotWrapper = document.createElement('div');
          const hasActivities = slot.activities.length > 0;

          const slotClasses = ['slot'];
          if (hasActivities) slotClasses.push('slot--filled');
          if (slot.isHoliday) slotClasses.push('slot--holiday');

          slotWrapper.className = slotClasses.join(' ');

          const slotLabel = document.createElement('button');
          slotLabel.type = 'button';
          slotLabel.className = 'slot__label slot__label-button';
          slotLabel.textContent = slot.label;
          slotLabel.addEventListener('click', () => openHalfDayModal(weekIndex, slotIndex));

          slotWrapper.appendChild(slotLabel);
          slotWrapper.appendChild(createSlotContent(weekIndex, slotIndex, slot));
          slotsContainer.appendChild(slotWrapper);
        });

        weekCard.appendChild(header);
        weekCard.appendChild(slotsContainer);
        timeline.appendChild(weekCard);
      });
    }

    async function loadActivitiesForCourse(courseId) {
      if (!courseId || !currentUser) return;

      courseStatus.textContent = 'Chargement des activités du cours...';
      courseHalfDays = [];

      try {
        const halfDayResponse = await authorizedFetch(`/api/courses/${courseId}/half-days`);
        if (!halfDayResponse.ok) {
          throw new Error();
        }

        const { halfDays } = await halfDayResponse.json();
        courseHalfDays = halfDays || [];
        halfDayHolidays = loadHolidayOverrides(courseId);
        schedule = buildSchedule(courseHalfDays, halfDayHolidays);
        renderSchedule();

        const response = await authorizedFetch(`/api/courses/${courseId}/activities`);
        if (!response.ok) {
          throw new Error();
        }

        const activities = await response.json();

        activities.forEach((activity) => {
          const weekIndex = activity.week - 1;
          const slotIndex = activity.slot;

          const targetSlot = schedule[weekIndex]?.slots?.[slotIndex];
          if (targetSlot && !targetSlot.isHoliday) {
            targetSlot.activities.push({
              id: activity.id,
              name: activity.name,
              type: activity.type,
              details: activity.details,
              duration: activity.duration,
              materials: activity.materials,
              actualStart: activity.actualStart,
              actualEnd: activity.actualEnd,
              sessionDate: activity.sessionDate,
              period: activity.period
            });
          }
        });

        courseStatus.textContent = '';
        renderSchedule();
        updateCourseHeader();
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = 'Impossible de charger les activités du cours.';
      }
    }

      async function persistActivity(payload) {
        try {
          const response = await authorizedFetch('/api/activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Sauvegarde impossible');
        }

        const body = await response.json();
        activityStatus.textContent = 'Activité enregistrée dans la base MariaDB.';
        return body.activityId;
      } catch (error) {
          if (error.message === 'UNAUTHORIZED') return null;
          activityStatus.textContent = `⚠️ ${error.message}`;
          return null;
        }
      }

      async function updateActivity(activityId, payload) {
        try {
          const response = await authorizedFetch(`/api/activities/${activityId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || "Impossible de mettre à jour l'activité.");
          }

          activityStatus.textContent = 'Activité mise à jour.';
          return true;
        } catch (error) {
          if (error.message === 'UNAUTHORIZED') return false;
          activityStatus.textContent = `⚠️ ${error.message}`;
          return false;
        }
      }

      async function deleteActivityById(activityId) {
        try {
          const response = await authorizedFetch(`/api/activities/${activityId}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || "Impossible de supprimer l'activité.");
          }

          activityStatus.textContent = 'Activité supprimée.';
          return true;
        } catch (error) {
          if (error.message === 'UNAUTHORIZED') return false;
          activityStatus.textContent = `⚠️ ${error.message}`;
          return false;
        }
      }

      async function updateActivityTiming(activityId, payload) {
        if (!activityId) return null;

        try {
          const response = await authorizedFetch(`/api/activities/${activityId}/timing`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Impossible de mettre à jour les heures réelles.');
          }

          activityStatus.textContent = 'Heures réelles mises à jour.';
          return response.json();
        } catch (error) {
          if (error.message === 'UNAUTHORIZED') return null;
          activityStatus.textContent = `⚠️ ${error.message}`;
          return null;
        }
      }

      async function moveActivity(activityId, weekNumber, slotIndex, position = null) {
        if (!activityId) return Promise.resolve();

        return authorizedFetch(`/api/activities/${activityId}/move`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ week: weekNumber, slot: slotIndex, position, courseId: currentCourseId })
        }).then(async (response) => {
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || "Impossible de mettre à jour l'activité.");
          }
        });
      }

      closeActivityModalBtn.addEventListener('click', closeActivityModal);
      activityModalBackdrop.addEventListener('click', closeActivityModal);
      openCourseModalBtn.addEventListener('click', openCourseModal);
      courseTitleButton.addEventListener('click', () => {
        if (courseTitleButton.getAttribute('aria-disabled') === 'true') return;
        openCourseEditor();
      });
      courseEditorCancelButton.addEventListener('click', closeCourseEditor);
      courseEditorDeleteButton.addEventListener('click', deleteCurrentCourse);
      closeCourseModalBtn.addEventListener('click', closeCourseModal);
      courseModalBackdrop.addEventListener('click', closeCourseModal);
      closeRescheduleModalBtn.addEventListener('click', closeRescheduleModal);
      cancelRescheduleButton.addEventListener('click', closeRescheduleModal);
      rescheduleModalBackdrop.addEventListener('click', closeRescheduleModal);
      closeHalfDayModalBtn.addEventListener('click', closeHalfDayModal);
      cancelHalfDayButton.addEventListener('click', closeHalfDayModal);
      halfDayModalBackdrop.addEventListener('click', closeHalfDayModal);
      halfDayHolidayToggle.addEventListener('click', () => {
        setHalfDayHolidayToggleState(!getHalfDayHolidayToggleState());
      });
      closeRealtimeModalBtn.addEventListener('click', closeRealtimeModal);
      realtimeModalBackdrop.addEventListener('click', closeRealtimeModal);
      realtimeCancelButton.addEventListener('click', closeRealtimeModal);
      realtimeForm.addEventListener('submit', handleRealtimeSubmit);
      realtimeClearButton.addEventListener('click', handleRealtimeClear);
      halfDayForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const isUpdated = updateHalfDayHolidayState(getHalfDayHolidayToggleState());
        if (isUpdated) {
          closeHalfDayModal();
        }
      });
      rescheduleForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (rescheduleWeekIndex === null) {
          closeRescheduleModal();
          return;
        }

        await rescheduleWeekDates(rescheduleWeekIndex, rescheduleDateInput.value.trim());
      });

      tabLogin.addEventListener('click', () => showAuthOverlay('login'));
      tabRegister.addEventListener('click', () => showAuthOverlay('register', registrationDisabledMessage));

      tabRegister.setAttribute('aria-disabled', 'true');
      tabRegister.classList.add('is-disabled');

      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        authStatus.textContent = 'Connexion en cours...';

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: loginEmailInput.value.trim(),
              password: loginPasswordInput.value
            })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Impossible de se connecter.');
          }

          const user = await response.json();
          setCurrentUser(user);
          hideAuthOverlay();
          loadCourses();
        } catch (error) {
          authStatus.textContent = `⚠️ ${error.message}`;
        }
      });

      registerForm.addEventListener('submit', (event) => {
        event.preventDefault();
        showAuthOverlay('register', registrationDisabledMessage);
      });

      logoutButton.addEventListener('click', async () => {
        await fetch('/api/auth/logout', { method: 'POST' });
        setCurrentUser(null);
        halfDayHolidays = {};
        halfDaySelection = { weekIndex: null, slotIndex: null };
        schedule = createEmptySchedule();
        renderSchedule();
        showAuthOverlay('login', 'Vous êtes déconnecté.');
      });

      async function checkSession() {
        try {
          const response = await fetch('/api/auth/me');
          if (!response.ok) {
            throw new Error();
          }

          const user = await response.json();
          setCurrentUser(user);
          hideAuthOverlay();
          await loadCourses();
        } catch (error) {
          setCurrentUser(null);
          showAuthOverlay('login');
        }
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (!courseModal.hasAttribute('hidden')) {
            closeCourseModal();
          }
          if (!activityModal.hasAttribute('hidden')) {
            closeActivityModal();
          }
          if (!courseEditor.classList.contains('is-hidden')) {
            closeCourseEditor();
          }
        }
      });

      duplicateActivityButton.addEventListener('click', () => {
        if (!editingActivity || !currentCourseId) return;

        const name = document.getElementById('activity-name').value.trim();
        const type = document.getElementById('type-select').value;
        const duration = Number(document.getElementById('duration').value) || 0;
        const details = document.getElementById('details').value.trim();
        const materials = document.getElementById('materials').value.trim();

        if (!name || duration <= 0) {
          activityStatus.textContent = 'Renseignez un nom et une durée valides pour dupliquer cette activité.';
          return;
        }

        const targetSlot = findNextHalfDaySlot(editingActivity.weekIndex, editingActivity.slotIndex);
        if (!targetSlot) {
          activityStatus.textContent = 'Aucune demi-journée suivante disponible pour dupliquer cette activité.';
          return;
        }

        activityStatus.textContent = "Duplication de l’activité en cours...";

        const activityPayload = {
          name,
          week: targetSlot.weekIndex + 1,
          slot: targetSlot.slotIndex,
          format: type,
          details,
          duration,
          materials,
          courseId: currentCourseId
        };

        const targetSlotRef = schedule?.[targetSlot.weekIndex]?.slots?.[targetSlot.slotIndex];
        if (!targetSlotRef) {
          activityStatus.textContent = 'La demi-journée cible est introuvable dans le planning.';
          return;
        }

        persistActivity(activityPayload).then((activityId) => {
          if (activityId) {
            const duplicatedActivity = {
              id: activityId,
              name,
              type,
              details,
              duration,
              materials,
              actualStart: null,
              actualEnd: null,
              sessionDate: targetSlotRef.sessionDate,
              period: targetSlotRef.period
            };
            targetSlotRef.activities.push(duplicatedActivity);
            renderSchedule();
            activityStatus.textContent = 'Activité dupliquée dans la demi-journée suivante.';
          }
        });
      });

      activityDeleteButton.addEventListener('click', () => {
        if (!editingActivity) return;

        const shouldDelete = window.confirm("Voulez-vous supprimer cette activité ?");
        if (!shouldDelete) return;

        activityStatus.textContent = "Suppression de l’activité en cours...";
        deleteActivityById(editingActivity.id).then((success) => {
          if (success) {
            removeActivityFromSchedule(editingActivity);
            renderSchedule();
            resetActivityFormDefaults();
            closeActivityModal();
          }
        });
      });

      activityForm.addEventListener('submit', (event) => {
        event.preventDefault();

      if (!currentCourseId) {
        activityStatus.textContent = 'Sélectionnez ou créez un cours avant d’ajouter une activité.';
        return;
      }

      const name = document.getElementById('activity-name').value.trim();
      const type = document.getElementById('type-select').value;
      const duration = Number(document.getElementById('duration').value) || 0;
      const details = document.getElementById('details').value.trim();
      const materials = document.getElementById('materials').value.trim();

      if (!name || duration <= 0) return;

      const targetWeekIndex = editingActivity ? editingActivity.weekIndex : creationWeekIndex;
      if (targetWeekIndex === null) {
        activityStatus.textContent = 'Choisissez une semaine pour ajouter une activité.';
        return;
      }

      const targetSlotIndex = editingActivity ? editingActivity.slotIndex : findNextSlotIndex(targetWeekIndex);
      if (targetSlotIndex === null || schedule[targetWeekIndex].slots[targetSlotIndex]?.isHoliday) {
        activityStatus.textContent = 'Impossible d’ajouter une activité sur une demi-journée marquée comme congé.';
        return;
      }

      const activityPayload = {
        name,
        week: targetWeekIndex + 1,
        slot: targetSlotIndex,
        format: type,
        details,
        duration,
        materials,
        courseId: currentCourseId
      };

      if (editingActivity) {
        activityStatus.textContent = "Mise à jour de l’activité en cours...";
        updateActivity(editingActivity.id, activityPayload).then((success) => {
          if (success) {
            const currentActivity =
              schedule[targetWeekIndex].slots[targetSlotIndex].activities[editingActivity.activityIndex] || {};
            const updatedActivity = {
              id: editingActivity.id,
              name,
              type,
              details,
              duration,
              materials,
              actualStart: currentActivity.actualStart || null,
              actualEnd: currentActivity.actualEnd || null,
              sessionDate: currentActivity.sessionDate,
              period: currentActivity.period
            };
            schedule[targetWeekIndex].slots[targetSlotIndex].activities[editingActivity.activityIndex] = updatedActivity;

            renderSchedule();
            resetActivityFormDefaults();
            closeActivityModal();
          }
        });
        return;
      }

      const targetSlot = schedule[targetWeekIndex].slots[targetSlotIndex];
      const activity = {
        name,
        type,
        details,
        duration,
        materials,
        actualStart: null,
        actualEnd: null,
        sessionDate: targetSlot.sessionDate,
        period: targetSlot.period
      };
      activityStatus.textContent = 'Enregistrement de l’activité en cours...';
      persistActivity(activityPayload).then((activityId) => {
        if (activityId) {
          targetSlot.activities.push({ ...activity, id: activityId });
          renderSchedule();
          resetActivityFormDefaults();
          closeActivityModal();
        }
      });
    });

    courseForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      courseStatus.textContent = 'Création du cours...';

      try {
        const payload = {
          className: document.getElementById('course-class').value.trim(),
          room: document.getElementById('course-room').value.trim(),
          moduleNumber: document.getElementById('course-number').value.trim(),
          moduleName: document.getElementById('course-name').value.trim(),
          generalObjective: courseGeneralObjectiveInput.value.trim(),
          particularites: courseParticularitiesInput.value.trim(),
          startDate: courseStartDateInput.value,
          startSlot: courseStartSlotSelect.value
        };

        const response = await authorizedFetch('/api/courses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Création impossible');
        }

        const createdCourse = await response.json();
        courseForm.reset();
        courseStatus.textContent = 'Cours créé avec succès !';
        currentCourseId = createdCourse.id;
        await loadCourses();
        closeCourseModal();
      } catch (error) {
        if (error.message === 'UNAUTHORIZED') return;
        courseStatus.textContent = `⚠️ ${error.message}`;
      }
    });

    courseEditorForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const moduleNumber = editCourseNumberInput.value.trim();
      const moduleName = editCourseNameInput.value.trim();
      const className = editCourseClassInput.value.trim();
      const room = editCourseRoomInput.value.trim();
      const generalObjective = editCourseGeneralObjectiveInput.value.trim();
      const particularites = editCourseParticularitiesInput.value.trim();

      if (!moduleNumber || !moduleName || !className || !room) {
        courseEditorStatus.textContent = 'Complétez tous les champs pour enregistrer les modifications.';
        return;
      }

      const success = await updateCourseMetadata({ moduleNumber, moduleName, className, room, particularites, generalObjective });

      if (success) {
        const course = getCurrentCourse();
        if (course) {
          course.moduleNumber = moduleNumber;
          course.moduleName = moduleName;
          course.className = className;
          course.room = room;
          course.generalObjective = generalObjective;
          course.particularites = particularites;
        }

        fillCourseSelect(coursesCache);
        updateCourseHeader();
        closeCourseEditor();
        courseStatus.textContent = 'Cours mis à jour.';
      }
    });

    courseSelect.addEventListener('change', async (event) => {
      if (!currentUser) {
        showAuthOverlay('login');
        return;
      }
      currentCourseId = Number(event.target.value);
      closeCourseEditor();
      updateCourseHeader();
      await loadActivitiesForCourse(currentCourseId);
    });

    renderFormatIcons();
    initializeFormatSelector();
    renderSchedule();
    checkSession();
  </script>
</body>
</html>
