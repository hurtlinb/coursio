<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coursio | Accueil</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <main class="sections">
    <section class="section planner" id="demo">
      <div class="planner__intro">
        <div class="section__title">Planifiez vos activit√©s</div>
        <p class="section__subtitle"></p>
      </div>

      <div class="course-toolbar" aria-label="S√©lection des cours">
        <div>
          <p class="label">Cours</p>
          <p class="muted">Choisissez un cours pour g√©rer les activit√©s, ou cr√©ez-en un nouveau.</p>
        </div>
        <div class="course-toolbar__actions">
          <label class="form-field form-field--inline">
            <span>Cours disponibles</span>
            <select id="course-select"></select>
          </label>
          <button class="icon-button" id="open-course-modal" type="button" aria-haspopup="dialog">
            <span aria-hidden="true">+</span>
            <span class="sr-only">Cr√©er un nouveau cours</span>
          </button>
          <button class="icon-button icon-button--danger" id="delete-course" type="button" aria-label="Supprimer le cours s√©lectionn√©">
            <span aria-hidden="true">üóë</span>
            <span class="sr-only">Supprimer le cours s√©lectionn√©</span>
          </button>
        </div>
      </div>

        <div class="planner__grid">
          <div class="timeline" aria-live="polite" aria-label="Planning des 5 semaines">
            <div class="timeline__header">
              <div>
                <p class="label">Planning</p>
                <h3>5 semaines, 3 demi-jours</h3>
                <p class="muted">Chaque carte repr√©sente une semaine. Ajoutez vos activit√©s pour remplir les cr√©neaux.</p>
              </div>
              <button class="icon-button" id="open-activity-modal" type="button" aria-haspopup="dialog">
                <span aria-hidden="true">+</span>
                <span class="sr-only">Ajouter une activit√©</span>
              </button>
            </div>
            <div class="timeline__grid" id="timeline"></div>
          </div>
        </div>
      </section>

  </main>

  <div class="activity-modal is-hidden" id="activity-modal" role="dialog" aria-modal="true" aria-labelledby="activity-modal-title" hidden>
    <div class="activity-modal__backdrop" data-close-activity-modal></div>
    <div class="activity-modal__content">
      <div class="activity-modal__header">
        <div>
          <p class="label" id="activity-modal-title">Nouvelle activit√©</p>
          <p class="muted">Renseignez les d√©tails pour l‚Äôajouter au planning.</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-activity-modal" type="button" aria-label="Fermer le formulaire">√ó</button>
      </div>

      <form class="activity-form" id="activity-form">
        <label class="form-field">
          <span>Nom de l'activit√©</span>
          <input type="text" id="activity-name" placeholder="Ex : Atelier de prototypage" required>
        </label>

        <div class="form-row">
          <label class="form-field">
            <span>Semaine (1 √† 5)</span>
            <select id="week-select">
              <option value="1">Semaine 1</option>
              <option value="2">Semaine 2</option>
              <option value="3">Semaine 3</option>
              <option value="4">Semaine 4</option>
              <option value="5">Semaine 5</option>
            </select>
          </label>
          <label class="form-field">
            <span>Demi-jour</span>
            <select id="slot-select">
              <option value="0">Matin</option>
              <option value="1">Apr√®s-midi</option>
            </select>
          </label>
        </div>

        <label class="form-field">
          <span>Format</span>
          <select id="type-select">
            <option value="presentation">Pr√©sentation</option>
            <option value="exercice">Exercice</option>
            <option value="travail_de_groupe">Travail de groupe</option>
            <option value="jeu">Jeu</option>
            <option value="recherche_information">Recherche d'information</option>
            <option value="synthese">Synth√®se</option>
            <option value="evaluation">√âvaluation</option>
          </select>
        </label>

        <label class="form-field">
          <span>Dur√©e (minutes)</span>
          <input type="number" id="duration" min="1" max="480" value="60" required>
        </label>

        <label class="form-field">
          <span>D√©tails (facultatif)</span>
          <textarea id="details" rows="3" placeholder="Objectifs, mat√©riel, format, etc."></textarea>
        </label>

        <label class="form-field">
          <span>Mat√©riel (facultatif)</span>
          <textarea id="materials" rows="2" placeholder="Listez les ressources utiles"></textarea>
        </label>

        <div class="course-form__actions">
          <button class="btn btn-primary" type="submit">Ajouter l'activit√©</button>
          <p class="muted" id="activity-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <div class="course-modal is-hidden" id="course-modal" role="dialog" aria-modal="true" aria-labelledby="course-modal-title" hidden>
    <div class="course-modal__backdrop" data-close-course-modal></div>
    <div class="course-modal__content">
      <div class="course-modal__header">
        <div>
          <p class="label" id="course-modal-title">Nouveau cours</p>
          <p class="muted">Renseignez les informations principales pour le cr√©er.</p>
        </div>
        <button class="icon-button icon-button--ghost" id="close-course-modal" type="button" aria-label="Fermer le formulaire">√ó</button>
      </div>

      <form class="course-form" id="course-form">
        <div class="form-row">
          <label class="form-field">
            <span>Enseignant</span>
            <input type="text" id="course-teacher" placeholder="Nom de l'enseignant" required>
          </label>
          <label class="form-field">
            <span>Classe</span>
            <input type="text" id="course-class" placeholder="Ex : BTS SIO" required>
          </label>
        </div>
        <div class="form-row">
          <label class="form-field">
            <span>Salle</span>
            <input type="text" id="course-room" placeholder="Ex : Salle 204" required>
          </label>
          <label class="form-field">
            <span>Module</span>
            <input type="text" id="course-number" placeholder="Ex : MOD-101" required>
          </label>
        </div>
        <label class="form-field">
          <span>Titre du module</span>
          <input type="text" id="course-name" placeholder="Nom du module" required>
        </label>
        <div class="form-row">
          <label class="form-field">
            <span>Date de d√©but</span>
            <input type="date" id="course-start-date" required>
          </label>
          <label class="form-field">
            <span>Demi-journ√©e de d√©but</span>
            <select id="course-start-slot">
              <option value="0">Matin</option>
              <option value="1">Apr√®s-midi</option>
            </select>
          </label>
        </div>
        <div class="course-form__actions">
          <button class="btn btn-primary" type="submit">Cr√©er le cours</button>
          <p class="muted" id="course-status" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>
  <script>
    const weeks = 5;
    const supportedFormats = {
      presentation: 'Pr√©sentation',
      exercice: 'Exercice',
      travail_de_groupe: 'Travail de groupe',
      jeu: 'Jeu',
      recherche_information: "Recherche d'information",
      synthese: 'Synth√®se',
      evaluation: '√âvaluation'
    };

    const dateFormatter = new Intl.DateTimeFormat('fr-FR', {
      weekday: 'short',
      day: '2-digit',
      month: '2-digit'
    });

    function formatHalfDayLabel(halfDay) {
      const periodLabel = halfDay.period === 'apres_midi' ? 'Apr√®s-midi' : 'Matin';
      const formattedDate = dateFormatter.format(new Date(halfDay.sessionDate));
      return `${formattedDate} ‚Ä¢ ${periodLabel}`;
    }

    function buildSchedule(halfDays = []) {
      const weeksSchedule = Array.from({ length: weeks }, (_, index) => ({
        week: index + 1,
        slots: Array.from({ length: 3 }, (__, slotIndex) => ({
          label: `Cr√©neau ${slotIndex + 1}`,
          activities: []
        }))
      }));

      halfDays.forEach((halfDay) => {
        const weekIndex = halfDay.weekNumber - 1;
        const slotIndex = halfDay.slotIndex;

        if (!weeksSchedule[weekIndex] || !weeksSchedule[weekIndex].slots[slotIndex]) return;

        weeksSchedule[weekIndex].slots[slotIndex] = {
          label: formatHalfDayLabel(halfDay),
          activities: []
        };
      });

      return weeksSchedule;
    }

    let schedule = buildSchedule();
    let courseHalfDays = [];

    const timeline = document.getElementById('timeline');
    const activityForm = document.getElementById('activity-form');
    const activityModal = document.getElementById('activity-modal');
    const activityModalBackdrop = document.querySelector('[data-close-activity-modal]');
    const activityStatus = document.getElementById('activity-status');
    const closeActivityModalBtn = document.getElementById('close-activity-modal');
    const courseForm = document.getElementById('course-form');
    const courseModal = document.getElementById('course-modal');
    const courseSelect = document.getElementById('course-select');
    const courseStatus = document.getElementById('course-status');
    const courseStartDateInput = document.getElementById('course-start-date');
    const courseStartSlotSelect = document.getElementById('course-start-slot');
    const deleteCourseBtn = document.getElementById('delete-course');
    const closeCourseModalBtn = document.getElementById('close-course-modal');
    const courseModalBackdrop = document.querySelector('[data-close-course-modal]');
    const openActivityModalBtn = document.getElementById('open-activity-modal');
    const openCourseModalBtn = document.getElementById('open-course-modal');
    const slotSelect = document.getElementById('slot-select');
    const weekSelect = document.getElementById('week-select');
    let coursesCache = [];
    let draggedActivity = null;
    let dropHandled = false;
    let currentCourseId = null;

      function resetActivityFormDefaults() {
        activityForm.reset();
        document.getElementById('duration').value = 60;
        weekSelect.value = 1;
        refreshSlotSelectOptions();
        slotSelect.value = 0;
      }

      function openActivityModal() {
        resetActivityFormDefaults();
        activityStatus.textContent = '';
        activityModal.removeAttribute('hidden');
        activityModal.classList.remove('is-hidden');
        document.getElementById('activity-name').focus();
      }

      function closeActivityModal() {
        activityModal.setAttribute('hidden', '');
        activityModal.classList.add('is-hidden');
      }

      function openCourseModal() {
        courseForm.reset();
        courseStatus.textContent = '';
        courseModal.removeAttribute('hidden');
        courseModal.classList.remove('is-hidden');
        courseStartDateInput.value = new Date().toISOString().slice(0, 10);
        courseStartSlotSelect.value = 0;
        document.getElementById('course-teacher').focus();
      }

      function closeCourseModal() {
        courseModal.setAttribute('hidden', '');
        courseModal.classList.add('is-hidden');
      }

      function getSlotsForWeek(weekNumber) {
        return courseHalfDays
          .filter((halfDay) => halfDay.weekNumber === weekNumber)
          .sort((a, b) => a.slotIndex - b.slotIndex);
      }

      function refreshSlotSelectOptions() {
        const selectedWeek = Number(weekSelect.value) || 1;
        const slots = getSlotsForWeek(selectedWeek);
        slotSelect.innerHTML = '';

        const slotList = slots.length > 0
          ? slots
          : Array.from({ length: 3 }, (_, index) => ({
              slotIndex: index,
              sessionDate: null,
              period: index % 2 === 0 ? 'matin' : 'apres_midi'
            }));

        slotList.forEach((halfDay) => {
          const option = document.createElement('option');
          option.value = halfDay.slotIndex;
          option.textContent = halfDay.sessionDate ? formatHalfDayLabel(halfDay) : `Cr√©neau ${halfDay.slotIndex + 1}`;
        slotSelect.appendChild(option);
      });
    }

    function fillCourseSelect(courses) {
      coursesCache = courses;
      courseSelect.innerHTML = '';

      courses.forEach((course) => {
        const option = document.createElement('option');
        option.value = course.id;
        option.textContent = `${course.moduleNumber} ‚Äî ${course.moduleName}`;
        option.dataset.moduleNumber = course.moduleNumber;
        courseSelect.appendChild(option);
      });

      const hasCurrentSelection = courses.some((course) => course.id === currentCourseId);

      if (!hasCurrentSelection) {
        currentCourseId = courses[0]?.id ?? null;
      }

      if (currentCourseId) {
        courseSelect.value = currentCourseId;
      }
    }

    async function loadCourses() {
      courseStatus.textContent = 'Chargement des cours...';

      try {
        const response = await fetch('/api/courses');
        if (!response.ok) {
          throw new Error();
        }

        const courses = await response.json();
        fillCourseSelect(courses);

        if (courses.length === 0) {
          courseStatus.textContent = 'Aucun cours disponible pour le moment.';
          currentCourseId = null;
          schedule = createEmptySchedule();
          renderSchedule();
          refreshSlotSelectOptions();
          return;
        }

        courseStatus.textContent = '';
        currentCourseId = Number(courseSelect.value);
        await loadActivitiesForCourse(currentCourseId);
      } catch (error) {
        courseStatus.textContent = 'Impossible de charger les cours.';
      }
    }

    function getCurrentCourse() {
      return coursesCache.find((course) => course.id === currentCourseId) || null;
    }

    async function deleteCurrentCourse() {
      if (!currentCourseId) {
        courseStatus.textContent = 'S√©lectionnez d‚Äôabord un cours √† supprimer.';
        return;
      }

      const course = getCurrentCourse();
      if (!course) {
        courseStatus.textContent = 'Cours introuvable dans la s√©lection.';
        return;
      }

      const confirmationMessage =
        `Pour supprimer le cours ${course.moduleNumber} (${course.moduleName}), saisissez son num√©ro de module. ` +
        'Cette action supprimera aussi tous les demi-jours et activit√©s associ√©s.';

      const userInput = window.prompt(confirmationMessage);

      if (userInput === null) {
        courseStatus.textContent = 'Suppression annul√©e.';
        return;
      }

      const moduleNumberInput = userInput.trim();

      if (moduleNumberInput !== course.moduleNumber) {
        courseStatus.textContent = 'Le num√©ro saisi ne correspond pas au cours s√©lectionn√©.';
        return;
      }

      courseStatus.textContent = 'Suppression du cours en cours...';

      try {
        const response = await fetch(`/api/courses/${course.id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ moduleNumber: moduleNumberInput })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Impossible de supprimer le cours.');
        }

        currentCourseId = null;
        courseStatus.textContent = 'Cours supprim√©.';
        await loadCourses();
      } catch (error) {
        courseStatus.textContent = `‚ö†Ô∏è ${error.message}`;
      }
    }

    function handleDragStart(event) {
      const { week, slot, index, id } = event.currentTarget.dataset;
      draggedActivity = {
        week: Number(week),
        slot: Number(slot),
        index: Number(index),
        id: Number(id)
      };
      dropHandled = false;
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', '');
      event.currentTarget.classList.add('is-dragging');
    }

    function handleDragEnd(event) {
      event.currentTarget.classList.remove('is-dragging');

      if (draggedActivity && !dropHandled) {
        const shouldDelete = window.confirm("Voulez-vous supprimer cette activit√© ?");
        if (shouldDelete) {
          const sourceSlot = schedule[draggedActivity.week].slots[draggedActivity.slot];
          sourceSlot.activities.splice(draggedActivity.index, 1);
          renderSchedule();
        }
      }

      draggedActivity = null;
      dropHandled = false;
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(event) {
      event.currentTarget.classList.add('slot__content--over');
    }

    function handleDragLeave(event) {
      event.currentTarget.classList.remove('slot__content--over');
    }

    function handleDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('slot__content--over');

      if (!draggedActivity) return;

      dropHandled = true;

      const targetWeek = Number(event.currentTarget.dataset.week);
      const targetSlot = Number(event.currentTarget.dataset.slot);

      if (draggedActivity.week === targetWeek && draggedActivity.slot === targetSlot) return;

      const sourceSlot = schedule[draggedActivity.week].slots[draggedActivity.slot];
      const [activity] = sourceSlot.activities.splice(draggedActivity.index, 1);
      schedule[targetWeek].slots[targetSlot].activities.push(activity);

      moveActivity(draggedActivity.id, targetWeek + 1, targetSlot).catch(() => {
        courseStatus.textContent = '‚ö†Ô∏è Impossible de mettre √† jour la base, rechargement du planning...';
        loadActivitiesForCourse(currentCourseId);
      });

      draggedActivity = null;
      renderSchedule();
    }

    function createActivityElement(activity, weekIndex, slotIndex, activityIndex) {
      const activityEl = document.createElement('div');
      activityEl.className = 'activity';
      activityEl.draggable = true;
      activityEl.dataset.week = weekIndex;
      activityEl.dataset.slot = slotIndex;
      activityEl.dataset.index = activityIndex;
      activityEl.dataset.id = activity.id;

      const header = document.createElement('div');
      header.className = 'activity__header';

      const title = document.createElement('span');
      title.className = 'activity__title';
      title.textContent = activity.name;

      const type = document.createElement('span');
      type.className = 'activity__type';
      type.textContent = supportedFormats[activity.type] || activity.type;

      header.appendChild(title);
      header.appendChild(type);

      activityEl.appendChild(header);

      const detailsText = `${activity.duration} min ‚Ä¢ ${activity.details || 'Description √† compl√©ter'}`;
      const details = document.createElement('p');
      details.className = 'activity__details';
      details.textContent = detailsText;
      activityEl.appendChild(details);

      if (activity.materials) {
        const materials = document.createElement('p');
        materials.className = 'activity__details';
        materials.textContent = `Mat√©riel : ${activity.materials}`;
        activityEl.appendChild(materials);
      }

      activityEl.addEventListener('dragstart', handleDragStart);
      activityEl.addEventListener('dragend', handleDragEnd);

      return activityEl;
    }

    function createSlotContent(weekIndex, slotIndex, slot) {
      const slotContent = document.createElement('div');
      slotContent.className = 'slot__content';
      slotContent.dataset.week = weekIndex;
      slotContent.dataset.slot = slotIndex;
      slotContent.addEventListener('dragover', handleDragOver);
      slotContent.addEventListener('dragenter', handleDragEnter);
      slotContent.addEventListener('dragleave', handleDragLeave);
      slotContent.addEventListener('drop', handleDrop);

      if (slot.activities.length === 0) {
        const empty = document.createElement('p');
        empty.className = 'empty';
        empty.textContent = 'Aucune activit√© planifi√©e';
        slotContent.appendChild(empty);
      } else {
        slot.activities.forEach((activity, activityIndex) => {
          slotContent.appendChild(createActivityElement(activity, weekIndex, slotIndex, activityIndex));
        });
      }

      return slotContent;
    }

    function renderSchedule() {
      timeline.innerHTML = '';

      schedule.forEach((week, weekIndex) => {
        const weekCard = document.createElement('article');
        weekCard.className = 'week-card';

        const header = document.createElement('header');

        const weekLabel = document.createElement('p');
        weekLabel.className = 'label';
        weekLabel.textContent = `Semaine ${week.week}`;

        const weekDescription = document.createElement('p');
        weekDescription.className = 'muted';
        weekDescription.textContent = '2 demi-jours pr√™ts √† accueillir vos activit√©s';

        header.appendChild(weekLabel);
        header.appendChild(weekDescription);

        const slotsContainer = document.createElement('div');
        slotsContainer.className = 'slots';

        week.slots.forEach((slot, slotIndex) => {
          const slotWrapper = document.createElement('div');
          const hasActivities = slot.activities.length > 0;

          slotWrapper.className = `slot ${hasActivities ? 'slot--filled' : ''}`;

          const slotLabel = document.createElement('div');
          slotLabel.className = 'slot__label';
          slotLabel.textContent = slot.label;

          slotWrapper.appendChild(slotLabel);
          slotWrapper.appendChild(createSlotContent(weekIndex, slotIndex, slot));
          slotsContainer.appendChild(slotWrapper);
        });

        weekCard.appendChild(header);
        weekCard.appendChild(slotsContainer);
        timeline.appendChild(weekCard);
      });
    }

    async function loadActivitiesForCourse(courseId) {
      if (!courseId) return;

      courseStatus.textContent = 'Chargement des activit√©s du cours...';

      try {
        const halfDayResponse = await fetch(`/api/courses/${courseId}/half-days`);
        if (!halfDayResponse.ok) {
          throw new Error();
        }

        const { halfDays } = await halfDayResponse.json();
        courseHalfDays = halfDays || [];
        schedule = buildSchedule(courseHalfDays);
        renderSchedule();
        refreshSlotSelectOptions();

        const response = await fetch(`/api/courses/${courseId}/activities`);
        if (!response.ok) {
          throw new Error();
        }

        const activities = await response.json();

        activities.forEach((activity) => {
          const weekIndex = activity.week - 1;
          const slotIndex = activity.slot;

          if (schedule[weekIndex] && schedule[weekIndex].slots[slotIndex]) {
            schedule[weekIndex].slots[slotIndex].activities.push({
              id: activity.id,
              name: activity.name,
              type: activity.type,
              details: activity.details,
              duration: activity.duration,
              materials: activity.materials
            });
          }
        });

        courseStatus.textContent = '';
        renderSchedule();
      } catch (error) {
        courseStatus.textContent = 'Impossible de charger les activit√©s du cours.';
      }
    }

      async function persistActivity(payload) {
        try {
          const response = await fetch('/api/activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Sauvegarde impossible');
        }

        const body = await response.json();
        activityStatus.textContent = 'Activit√© enregistr√©e dans la base MariaDB.';
        return body.activityId;
      } catch (error) {
          activityStatus.textContent = `‚ö†Ô∏è ${error.message}`;
          return null;
        }
      }

      async function moveActivity(activityId, weekNumber, slotIndex) {
        if (!activityId) return Promise.resolve();

        return fetch(`/api/activities/${activityId}/move`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ week: weekNumber, slot: slotIndex, courseId: currentCourseId })
        }).then(async (response) => {
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || "Impossible de mettre √† jour l'activit√©.");
          }
        });
      }

      openActivityModalBtn.addEventListener('click', openActivityModal);
      closeActivityModalBtn.addEventListener('click', closeActivityModal);
      activityModalBackdrop.addEventListener('click', closeActivityModal);
      openCourseModalBtn.addEventListener('click', openCourseModal);
      if (deleteCourseBtn) {
        deleteCourseBtn.addEventListener('click', deleteCurrentCourse);
      }
      closeCourseModalBtn.addEventListener('click', closeCourseModal);
      courseModalBackdrop.addEventListener('click', closeCourseModal);
      weekSelect.addEventListener('change', refreshSlotSelectOptions);
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (!courseModal.hasAttribute('hidden')) {
            closeCourseModal();
          }
          if (!activityModal.hasAttribute('hidden')) {
            closeActivityModal();
          }
        }
      });

      activityForm.addEventListener('submit', (event) => {
        event.preventDefault();

      if (!currentCourseId) {
        activityStatus.textContent = 'S√©lectionnez ou cr√©ez un cours avant d‚Äôajouter une activit√©.';
        return;
      }

      const name = document.getElementById('activity-name').value.trim();
      const weekIndex = Number(weekSelect.value) - 1;
      const slotIndex = Number(slotSelect.value);
      const type = document.getElementById('type-select').value;
      const duration = Number(document.getElementById('duration').value) || 0;
      const details = document.getElementById('details').value.trim();
      const materials = document.getElementById('materials').value.trim();

      if (!name || duration <= 0) return;

      const targetSlot = schedule[weekIndex].slots[slotIndex];
      const activity = { name, type, details, duration, materials };
      activityStatus.textContent = 'Enregistrement de l‚Äôactivit√© en cours...';
      persistActivity({
        name,
        week: weekIndex + 1,
        slot: slotIndex,
        format: type,
        details,
        duration,
        materials,
        courseId: currentCourseId
      }).then((activityId) => {
        if (activityId) {
          targetSlot.activities.push({ ...activity, id: activityId });
          renderSchedule();
          resetActivityFormDefaults();
          closeActivityModal();
        }
      });
    });

    courseForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      courseStatus.textContent = 'Cr√©ation du cours...';

      try {
        const payload = {
          teacher: document.getElementById('course-teacher').value.trim(),
          className: document.getElementById('course-class').value.trim(),
          room: document.getElementById('course-room').value.trim(),
          moduleNumber: document.getElementById('course-number').value.trim(),
          moduleName: document.getElementById('course-name').value.trim(),
          startDate: courseStartDateInput.value,
          startSlot: courseStartSlotSelect.value
        };

        const response = await fetch('/api/courses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Cr√©ation impossible');
        }

        const createdCourse = await response.json();
        courseForm.reset();
        courseStatus.textContent = 'Cours cr√©√© avec succ√®s !';
        currentCourseId = createdCourse.id;
        await loadCourses();
        closeCourseModal();
      } catch (error) {
        courseStatus.textContent = `‚ö†Ô∏è ${error.message}`;
      }
    });

    courseSelect.addEventListener('change', async (event) => {
      currentCourseId = Number(event.target.value);
      await loadActivitiesForCourse(currentCourseId);
    });

    renderSchedule();
    refreshSlotSelectOptions();
    loadCourses();
  </script>
</body>
</html>
